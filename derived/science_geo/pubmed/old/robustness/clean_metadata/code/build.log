
  ___  ____  ____  ____  ____ ©
 /__    /   ____/   /   ____/      17.0
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2021 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-STATA-PC        https://www.stata.com
                                   979-696-4600        stata@stata.com

Stata license: Unlimited-user 4-core , expiring 17 Nov 2023
Serial number: 501709306977
  Licensed to: Harvard Business School
               Research Computing

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 120,000; see help set_maxvar.

. do "/export/home/dor/cxu/innovation_projs/derived/science_geo/robustness/clea
> n_metadata/code/build.do" 

. set more off

. clear all

. capture log close

. program drop _all

. set scheme modern

. pause on

. set seed 8975

. here, set
/export/home/dor/cxu/innovation_projs/derived/science_geo/robustness/clean_meta
> data/code/

. set maxvar 120000


. 
. program main
  1.     foreach samp in natsub demsci {
  2.         qui clean_mesh, samp(`samp')
  3.         di "done clean_mesh"
  4.         qui clean_date, samp(`samp')
  5.         di "done clean_date"
  6.         qui clean_journal, samp(`samp')
  7.         di "done clean_journal"
  8.         qui clean_pubtype, samp(`samp')
  9.         di "done clean_pubtype"
 10.         qui clean_authors, samp(`samp')
 11.         di "done clean_authors"
 12.         qui clean_affls, samp(`samp')
 13.         di "done clean_affls"
 14.         qui reshape_mult_affiliations, samp(`samp')
 15.         di "done reshape_mult_affiliations"
 16.         qui reshape_mesh_terms, samp(`samp')
 17.         di "done reshape_mesh_terms"
 18.         clean_geo, samp(`samp')
 19.         di "done clean_geo"
 20.     }
 21. end

. 
. program clean_mesh
  1.     syntax, samp(str)
  2.     use ../external/samp/`samp'_to_clean, clear
  3.         gen mesh_na = mesh == "NA"
  4.         tab mesh_na
  5.     drop mesh_na
  6.         replace mesh = subinstr(mesh, char(34), "", .)
  7.     replace mesh = subinstr(mesh, "<MeshHeadingList>","",.)
  8.     replace mesh = subinstr(mesh, "</MeshHeadingList>","",.)
  9.         split mesh, p("</MeshHeading>") 
 10.         rename mesh raw_mesh
 11.         egen nterms = noccur(raw_mesh), string("<MeshHeading>")
 12.         qui sum nterms
 13.         local max_nterms = r(max)
 14.         forval x=1/`max_nterms' {
 15.         replace mesh`x' = "" if strpos(mesh`x', "MajorTopicYN=Y") == 0
 16.         cap assert mi(mesh`x')
 17.         if !_rc {
 18.             drop mesh`x'
 19.         }
 20.         cap gen descriptor_start = strpos(mesh`x', "<DescriptorName")+42
 21.         cap gen descriptor_end  = strpos(mesh`x', "</DescriptorName")
 22.         cap gen descriptor_len = descriptor_end - descriptor_start
 23.         cap gen desc_mesh`x' = substr(mesh`x', descriptor_start, descripto
> r_len)
 24.         cap replace mesh`x' = subinstr(mesh`x',substr(mesh`x',1, descripto
> r_end+16), "", .)
 25.         cap drop descriptor*
 26.         cap rename mesh`x' mesh`x'_
 27.         cap split mesh`x'_, p("</QualifierName>")
 28.         cap rename mesh`x'_ raw_mesh`x'
 29.     }
 30.     qui ds mesh*_*
 31.     foreach var in `r(varlist)' {
 32.         replace `var' = "" if strpos(`var', "MajorTopicYN=N") > 0
 33.         cap gen maj_start = strpos(`var', "MajorTopicYN=Y")
 34.         cap gen maj_len = strlen(`var') - (maj_start + 15)
 35.         cap replace `var' = substr(`var', maj_start + 15, maj_len + 1) if 
> maj_start > 0
 36.         cap drop maj_*
 37.         local prefix = substr("`var'", 1,strpos("`var'", "_")-1)
 38.         cap replace `var' = desc_`prefix' + ", " + `var' if !mi(`var')
 39.         cap assert(mi`var')
 40.         if !_rc {
 41.             drop  `var'
 42.         }
 43.     }
 44.     qui ds mesh*_*
 45.     foreach var in `r(varlist)' {
 46.         local prefix = substr("`var'", 1,strpos("`var'", "_")-1)
 47.         cap replace desc_`prefix' = "" if !mi(`var')
 48.     } 
 49.     drop raw_* 
 50.     rename (desc_mesh*) (mesh*_0)
 51.     qui compress mesh*, nocoalesce
 52.         /*local max_1 = `max_nterms' - 1
>         forval i = 1/`max_1' {
>                 local j = `i' + 1
>                 forval k = `j'/`max_nterms' {
>                         qui replace mesh`i' = mesh`k' if mesh`i' == "" & mesh
> `k' != ""
>                         qui replace mesh`k' = "" if mesh`k' == mesh`i'
>                 }
>                 qui compress mesh`i', nocoalesce
>         }*/
.     save ../temp/cleaned_mesh_`samp', replace
 53.     drop mesh*
 54. end

. 
. program clean_date
  1.     syntax, samp(str)
  2.         rename date date_raw
  3.         gen start = strpos(date_raw, "<Year>") + 6
  4.         gen y = substr(date_raw, start, 4)
  5.         destring y, replace
  6.         drop start
  7. 
.         gen start = strpos(date_raw, "<Month>") + 7
  8.         gen m = substr(date_raw, start, 2)
  9.         destring m, replace
 10.         drop start
 11. 
.         gen start = strpos(date_raw, "<Day>") + 5
 12.         gen d = substr(date_raw, start, 2)
 13.         destring d, replace
 14.         drop start
 15. 
.         gen date = mdy(m, d, y)
 16.         format date  %td
 17.         drop d m y
 18.     save ../temp/cleaned_date_`samp', replace
 19. end

. 
. program clean_journal
  1.     syntax, samp(str)
  2.         gen journal_na = journal == "NA"
  3.         tab journal_na
  4. 
.         ren journal journal_raw
  5.         gen start = strpos(journal_raw, "<Title>") + 7
  6.         gen end = strpos(journal_raw, "</Title>")
  7.         gen len = end-start
  8. 
.         gen journal = substr(journal_raw, start, len) if start != 7
  9.         drop start end len
 10. 
.         gen start = strpos(journal_raw, "<ISOAbbreviation>") + 17
 11.         gen end = strpos(journal_raw, "</ISOAbbreviation>")
 12.         gen len = end-start
 13. 
.         gen journal_abbr = substr(journal_raw, start, len) if start != 17
 14.         drop start end len
 15.     if "`data'" == "basic" {
 16.         keep if inlist(journal_abbr, "Cell", "Nature", "Science")
 17.     }
 18.     save ../temp/cleaned_jrnl_`samp', replace
 19. end

. 
. program clean_pubtype
  1.     syntax, samp(str)
  2.     use ../temp/cleaned_jrnl_`samp',clear 
  3.         gen pt_na = pt == "NA"
  4.         tab pt_na
  5.     drop pt_na
  6.         replace pt = subinstr(pt, char(34), "", .)
  7.     replace pt = subinstr(pt, "</PublicationTypeList>", "",.)
  8.     replace pt = subinstr(pt, "<PublicationTypeList> ", "",.)
  9.     split pt, p("</PublicationType>")
 10.         ren pt raw_pt
 11.     qui ds pt*
 12.     local pts `r(varlist)'
 13.     local num_pts : list sizeof pts
 14.     gen start = .
 15.     forval i = 1/`num_pts' { 
 16.         replace start = strpos(pt`i', ">")+1
 17.         replace pt`i' = substr(pt`i', start, strlen(pt`i')-start+1)
 18.     }
 19.     gen to_drop = 0
 20.     gen pub_type = ""
 21.     forval i = 1/`num_pts' {
 22.        replace to_drop = 1 if inlist(pt`i', "Autobiography", "Biography", 
> "Case Reports", "Classical Article", "Comment", "Comparative Study", "Congres
> s", "Dataset", "Editorial")
 23.        replace to_drop = 1 if inlist(pt`i', "Evaluation Study", "Historica
> l Article", "Introductory Journal Article", "Letter" , "News", "Clinical Conf
> erence", "Practice Guideline", "Guideline")
 24.        replace to_drop = 1 if inlist(pt`i', "Meta-Analysis", "Personal Nar
> rative", "Portrait", "Published Erratum", "Retracted Publication", "Review", 
> "Video-Audio Media", "Webcast", "Legal Case")
 25.        replace to_drop = 1 if inlist(pt`i', "Retraction of Publication", "
> Twin Study", "Systematic Review", "Address" , "Bibliography", "Consensus Deve
> lopment Conference" , "Consensus Development Conference, NIH")
 26.        replace to_drop = 1 if inlist(pt`i', "Corrected and Republished Art
> icle", "Duplicate Publication","Interactive Tutorial", "Expression of Concern
> ", "Lecture","Multicenter Study", "Patient Education Handout" , "Validation S
> tudy") 
 27.         replace pub_type = "Journal Article" if pt`i' == "Journal Article"
 28.         replace pub_type = "Clinical Study" if strpos(pt`i', "Clinical Stu
> dy")
 29.         replace pub_type = "Clinical Trial" if strpos(pt`i', "Clinical Tri
> al")
 30.         replace pub_type = pt`i' if mi(pub_type)
 31.     }
 32.         drop if to_drop == 1
 33.     save ../temp/cleaned_pubtype_`samp', replace
 34. end

. 
. program clean_authors
  1.     syntax, samp(str)
  2.         use ../temp/cleaned_pubtype_`samp',clear 
  3.         rename athrs athrs_raw
  4.         gen athrs = athrs_raw
  5.         replace athrs = subinstr(athrs, char(34), "", .)
  6.         replace athrs = subinstr(athrs, "<AuthorList CompleteYN=Y>","",.)
  7.         split athrs, p("</Author> ")
  8.         egen num_athrs = noccur(athrs), string("<Author ValidYN=Y>")
  9.         qui sum num_athrs
 10.         local max_authors = r(max)
 11.         foreach var in last_name first_name affiliation {
 12.                 gen `var'_start = .
 13.                 gen `var'_end = . 
 14.         }
 15.         forval i = 1/`max_authors' {
 16.                 replace athrs`i' = subinstr(athrs`i', "<Author ValidYN=Y> 
>    ","",.)
 17.                 replace last_name_start = strpos(athrs`i', "<LastName>") +
>  10
 18.                 replace last_name_end = strpos(athrs`i', "</LastName>")
 19.                 gen last_name`i' = substr(athrs`i', last_name_start, last_
> name_end-last_name_start)
 20.                 replace first_name_start = strpos(athrs`i', "<ForeName>") 
> + 10
 21.                 replace first_name_end = strpos(athrs`i', "</ForeName>")
 22.                 gen first_name`i' = substr(athrs`i', first_name_start, fir
> st_name_end-first_name_start)
 23.                 replace affiliation_start = strpos(athrs`i', "<Affiliation
> Info>") + 17
 24.                 replace affiliation_end = strrpos(athrs`i', "</Affiliation
> Info>")
 25.                 gen affiliation`i' = substr(athrs`i',affiliation_start, af
> filiation_end- affiliation_start)
 26.                 egen num_affiliations`i' = noccur(athrs`i'), string("<Affi
> liation>")
 27.         }
 28.     compress, nocoalesce
 29.     save ../temp/cleaned_authors_`samp', replace
 30. end

. 
. program clean_affls
  1.     syntax, samp(str)
  2.     use ../temp/cleaned_authors_`samp',clear 
  3.     missings dropvars, force
  4.         foreach var in last_name first_name affiliation {
  5.                 cap drop `var'_start `var'_end 
  6.         }
  7.         
.         qui ds affiliation*
  8.         foreach var in `r(varlist)' {
  9.                 rename `var' `var'_
 10.                 split `var'_, p("</AffiliationInfo>")
 11. 
.                 rename `var'_ `var'_raw
 12.         }
 13.         qui ds affiliation*
 14.         foreach var in `r(varlist)' {
 15.                 replace `var' = subinstr(`var', "<AffiliationInfo>      <A
> ffiliation>","",.)
 16.                 replace `var' = subinstr(`var', "</Affiliation>    </Affil
> iationInfo>","",.)
 17.                 replace `var' = subinstr(`var', "<Affiliation>","",.)
 18.                 replace `var' = subinstr(`var', "</Affiliation>","",.)
 19.                 replace `var' = subinstr(`var', "</AffiliationInfo>","",.)
 20.                 replace `var' = subinstr(`var', "<AffiliationInfo>","",.)
 21.         }
 22.         gegen most_affiliations = rowmax(num_affiliations*)
 23.     compress, nocoalesce
 24.     save ../temp/pre_reshape_`samp', replace
 25. end

. 
. program reshape_mult_affiliations
  1.     syntax, samp(str)
  2.     use ../temp/pre_reshape_`samp', clear
  3.     keep if pub_type == "Journal Article"
  4.     sum most_affiliations
  5.     local most = r(max)
  6.     forval i = 1/`most' {
  7.         local vars `vars' affiliation@_`i'
  8.     }
  9.         cap drop *_raw athrs* num_affiliations* journal_na gr num_athrs nt
> erms pub_type most_affiliations to_drop pt* start raw_pt
 10.         *keep pmid *name* affiliation*
.         sreshape long last_name first_name `vars', i(pmid journal date journa
> l_abbr) j(which_athr) missing(drop all)    
 11.     drop if mi(first_name) & mi(last_name)
 12.         sreshape long affiliation_, i(pmid which_athr last_name first_name
> ) j(which_affiliation) missing(drop)
 13.         rename affiliation_ affiliation
 14.         *drop if mi(affiliation)
.     compress, nocoalesce
 15.         save ../output/pmid_author_affiliation_list_`samp', replace       
>       
 16. end

. 
. program reshape_mesh_terms
  1.     syntax, samp(str)
  2.     use ../temp/cleaned_mesh_`samp', clear
  3.     keep pmid mesh*
  4.     cap drop mesh_na mesh_raw
  5.     compress, nocoalesce
  6.     local max = 0
  7.     qui ds mesh*
  8.     local vars `r(varlist)'
  9.     foreach var in `vars' {
 10.        local suf = substr("`var'", strpos("`var'", "_")+1, strlen("`var'")
> -strpos("`var'","_"))
 11.        if `suf' > `max' {
 12.            local max = `suf'
 13.        }
 14.     }
 15.     local vars ""
 16.     forval i = 0/`max' {
 17.         local vars `vars' mesh@_`i'
 18.     }
 19.     sreshape long `vars', i(pmid) j(which_mesh) missing(drop)
 20.     sreshape long mesh_, i(pmid which_mesh) j(add_mesh) missing(drop)
 21.     drop which_mesh add_mesh
 22.     bys pmid: gen which_mesh = _n
 23.     rename mesh_ mesh
 24.     replace mesh = subinstr(mesh, "&amp", "&", .)
 25.     compress, nocoalesce
 26.     save ../output/major_mesh_terms_`samp', replace
 27. end

. 
. program clean_geo
  1.     syntax, samp(str)
  2.     qui {
  3.         import delimited ../external/geo/country_list.csv, varnames(1) cle
> ar
  4.         qui glevelsof name, local(country_names)
  5.         qui glevelsof code, local(country_abbrs)
  6.         gen no_comma = substr(name,1,strpos(name,",")-1)
  7.         preserve
  8.         drop if mi(no_comma) | no_comma == "Korea"
  9.         glevelsof no_comma, local(more_country_names)
 10.         restore
 11.         save ../temp/countries, replace
 12. 
.         import delimited ../external/geo/us_cities_states_counties.csv, varna
> mes(1) clear
 13.         glevelsof statefull, local(state_names)
 14.         glevelsof stateshort, local(state_abbr)
 15.         gen city_state = city + ", " + stateshort + ", " + statefull
 16.         qui glevelsof city_state, local(uscity_names)
 17.         qui glevelsof city, local(uscity)
 18.         foreach s in `state_abbr' {
 19.             qui glevelsof city, local(`s'_cities)
 20.         }
 21.         save ../temp/us_cities_states_counties, replace 
 22.         gcontract stateshort statefull
 23.         drop _freq
 24.         drop if mi(stateshort)
 25.         save ../temp/state_abbr_xwalk, replace
 26.         
.         import delimited ../external/geo/world-cities_csv.csv, varnames(1) cl
> ear
 27.         keep name country
 28.         rename name city
 29.         replace city = ustrregexra(ustrnormalize(city,"nfd"), "\p{Mark}", 
> "")
 30.         gen city_name = city + ", " + country
 31.         drop if country == "United States"
 32.         qui glevelsof city_name, local(big_country)
 33.         save ../temp/world_cities, replace 
 34.         
.         import excel ../external/geo/ZIP_CBSA_122021.xlsx, firstrow clear
 35.         keep zip cbsa usps_zip_pref_city usps_zip_pref_state
 36.         replace usps_zip_pref_city = strproper(usps_zip_pref_city)
 37.         save ../temp/zip_city, replace
 38.         gcontract zip usps_zip_pref_city usps_zip_pref_state
 39.         rename usps_zip_pref_state state_zip
 40.         rename usps_zip_pref_city city_zip 
 41.         drop _freq
 42.         save ../temp/list_zips, replace
 43. 
.         import delimited ../external/geo/wikipedia-iso-country-codes.csv, cle
> ar
 44.         keep english alpha*
 45.         rename (englis alpha2code alpha3code) (country_name alpha2 alpha3)
 46.         save ../temp/country2_3_xwalk, replace
 47. 
.         import delimited ../external/geo/research_institution_rank.csv, clear
 48.         drop *rank*
 49.         replace institution = subinstr(institution, "*", "", .)
 50.         replace institution = strtrim(institution)
 51.         keep institution country 
 52.         rename country alpha3
 53.         merge m:1 alpha3 using ../temp/country2_3_xwalk, keep(1 3) nogen
 54.         drop alpha3
 55.         rename alpha2 country
 56.         save ../temp/list_of_institutions, replace
 57. 
.         import delimited ../external/geo/world-universities.csv, clear
 58.         keep v1 v2 
 59.         rename (v1 v2) (country institution)
 60.         order institution country 
 61.         save ../temp/universities, replace
 62.         append using ../temp/list_of_institutions
 63.         gduplicates drop institution country , force
 64.         replace institution = subinstr(institution, `"""', "", .)
 65.         rename country code
 66.         merge m:1 code using ../temp/countries, assert(1 2 3) keep(1 3) no
> gen 
 67.         replace country_name = no_comma if !mi(no_comma)
 68.         replace country_name = name if mi(country_name)
 69.         qui glevelsof institution, local(institutions)
 70.         save ../temp/institutions, replace 
 71. 
.         gduplicates tag institution, gen(dup)
 72.         keep if dup == 0 
 73.         drop dup 
 74.         save ../temp/unique_institutions, replace
 75.     }
 76. 
.     di "Done creating xwalks"
 77.     
.     qui {
 78.         use ../output/pmid_author_affiliation_list_`samp', clear
 79.         replace affiliation = subinstr(affiliation , "&amp;","&",.)
 80.         replace affiliation = "" if strpos(affiliation, "listed in the sup
> plementary materials") > 0 | strpos(affiliation, "supplementary materials") >
>  0
 81. 
.         replace affiliation = ustrregexra(ustrnormalize(affiliation,"nfd"), "
> \p{Mark}", "")
 82.         replace affiliation = subinstr(affiliation, "é", "e",.)
 83.         replace affiliation = subinstr(affiliation, "Univ.", "University",
> .)
 84.         replace affiliation = subinstr(affiliation, "Ã¼", "u",.)
 85.         replace affiliation = subinstr(affiliation, "A¼", "u",.)
 86.         replace affiliation = subinstr(affiliation, "Ã¤", "a", .)
 87.         replace affiliation = subinstr(affiliation, "A¡", "a", .)
 88.         replace affiliation = subinstr(affiliation, "A³","o",.)
 89.         replace affiliation = subinstr(affiliation, "A¯", "u", .)
 90.         replace affiliation = subinstr(affiliation, "A£", "a", .)
 91.         replace affiliation = subinstr(affiliation, "A§", "c", .)
 92.         replace affiliation = subinstr(affiliation, "A§", "c", .)
 93.         replace affiliation = subinstr(affiliation, "A´", "o", .)
 94.         replace affiliation = subinstr(affiliation, "A¤", "a", .)
 95.         replace affiliation = subinstr(affiliation, "A¶", "o", .)
 96.         replace affiliation = subinstr(affiliation, "A©", "e", .)
 97.         replace affiliation = subinstr(affiliation, "A¥", "a", .)
 98.         replace affiliation = subinstr(affiliation, "A¢", "a", .)
 99.         replace affiliation = subinstr(affiliation, "A±", "u", .)
100. 
.         split affiliation , parse("; " "[2]" "[3]" "[4]" "[5]" "[6]" "[7]")
101.         rename affiliation affiliation0
102.         drop affiliation0
103.         sreshape long affiliation, i(pmid which_athr which_affiliation las
> t_name first_name) j(add_to_affiliation) missing(drop)
104.         replace add_to_affiliation = add_to_affiliation - 1
105.         replace which_affiliation = which_affiliation + add_to_affiliation
106.         replace affiliation= subinstr(affiliation, "1] ", "", .)
107.         drop add_to_affiliation
108.         gen edit_affiliation = affiliation
109.         save ../temp/pmid_author_affiliation_list_expanded_`samp', replace
110.     }
111.     di "Done prepping clean_geo"
112.     
.     qui {
113.         use ../temp/pmid_author_affiliation_list_expanded_`samp', clear
114.         gen country = "" 
115.         gen ncountries = 0
116.         foreach c in " U.K." " UK." " USA." " UK " " USA "  " USA" "Englan
> d" `country_names' `more_country_names' "South Korea" "Republic of Korea" " U
> SSR" " Russia" " UK" {
117.             qui replace ncountries = ncountries + 1 if strpos(affiliation,
>  "`c'") > 0
118.             qui replace country = "`c'" if strpos(affiliation, "`c'") > 0 
> & country == ""
119.             qui replace country = "`c'" if country != "" & strpos(affiliat
> ion, "`c'") > 0 & strpos(affiliation, "`c'") > strpos(affiliation, country)
120.             if "`c'" == "Lebanon" {
121.                 qui replace country = "United States" if strpos(affiliatio
> n, "Dartmouth") > 0
122.             }
123.             if "`c'" == "Israel" {
124.                 qui replace country = "United States" if strpos(affiliatio
> n, "Beth Israel") > 0
125.             }
126.             if "`c'" == "India" {
127.                 qui replace country = "United States" if strpos(affiliatio
> n, "Indiana") > 0
128.             }
129.             if "`c'" == "Jersey" {
130.                qui replace country = "United States" if substr(affiliation
> , strpos(affiliation, "`c'")-4,3) == "New" & country == "Jersey"
131.             }
132.             if "`c'" == "Georgia" {
133.                qui replace country = "United States" if strpos(affiliation
> , "Atlanta")>0  |  strpos(affiliation, "Athens")>0 | strpos(affiliation, "Aug
> usta") > 0
134.             }
135.         }
136.         replace country = "Taiwan" if strpos(affiliation, "Taiwan") >0
137.         replace country = "Germany" if strpos(affiliation, ", FRG") > 0 
138.         replace country = "Germany" if strpos(affiliation , "Max-Planck")>
> 0 & mi(country)
139.         replace country = "Germany" if strpos(affiliation , "Max Planck")>
> 0 & mi(country)
140.         replace affiliation = subinstr(affiliation, "Max-Planck", "Max Pla
> nck", .)
141.         qui replace edit_affiliation = subinword(edit_affiliation, country
> , "",.) if !mi(country)
142.         replace country = "South Korea" if country == "Republic of Korea"
143.         replace country = "South Korea" if country == "Korea, Republic of"
144.         replace country = "South Korea" if strpos(affiliation, "Korea")>0
145.         replace country = "South Korea" if mi(country) & strpos(affiliatio
> n, "Seoul") > 0
146.         replace country = "Japan" if mi(country) & strpos(affiliation, "To
> kyo") > 0
147.         replace country = "Russia" if country == "Russian Federation"
148.         replace country = "Russia" if country == "USSR"
149.         replace country = "United Kingdom" if inlist(country,  " U.K.", " 
> UK.", " UK ", "England") 
150.         replace country = "United Kingdom" if strpos(affiliation, "Scotlan
> d") > 0
151.         replace country = "United States" if inlist(country, " USA.", " US
> A ", " USA") 
152.         replace country = "United States" if mi(country) & (strpos(affilia
> tion, "Harvard University") > 0 | strpos(affiliation, "Stanford University") 
> > 0 | strpos(affiliation, "Johns Hopkins University")> 0)
153.         save ../temp/cleaned_countries_`samp', replace
154.     }
155.     di "done clean countries"
156.     
.     qui {
157.         use ../temp/cleaned_countries_`samp', clear
158.         gen us_state = ""
159.         gen nstates = 0
160.         foreach s in `state_names' {
161.             qui replace nstates = nstates + 1 if strpos(affiliation, "`s'"
> ) > 0
162.             qui replace country = "United States" if strpos(affiliation, "
> `s'") > 0 & country == ""
163.             qui replace us_state = "`s'" if country == "United States" & s
> trpos(affiliation, "`s'") > 0
164.             qui replace us_state = "`s'" if us_state!= "" & strpos(affilia
> tion, "`s'") > 0 & strpos(affiliation, "`s'") > strpos(affiliation, us_state)
165.         }
166.         qui replace edit_affiliation = subinstr(edit_affiliation, us_state
> , "",.) if !mi(us_state)
167.         gen statefull = us_state 
168.         merge m:1 statefull using ../temp/state_abbr_xwalk, assert(1 2 3) 
> keep(1 3) nogen
169.         replace us_state = stateshort if !mi(statefull)
170.         replace us_state = "MO" if strpos(affiliation, "Washington Univers
> ity") > 0 & strpos(affiliation, "Western Washington University") == 0 & strpo
> s(affiliation, "George Washington University") == 0 & strpos(affiliation, "Ce
> ntral Washington University") > 0
171.         replace us_state = "DC" if strpos(affiliation, " DC ") > 0 & count
> ry == "United States"
172.         replace us_state = "NJ" if strpos(affiliation, "Princeton Universi
> ty") > 0
173.         replace us_state = "WA" if strpos(affiliation, "Alaska Fisheries S
> cience Center") > 0
174.         save ../temp/cleaned_states_`samp', replace
175.     }
176. 
.     di "done cleaned US states"
177. 
.     qui {
178.         use ../temp/cleaned_states_`samp', clear
179.         gen city = ""
180.         local i = 1
181.         foreach c in `uscity_names' { 
182.             di "`i'"
183.             local city_name = substr("`c'", 1, strpos("`c'",",")-1)
184.             local state = substr("`c'", strpos("`c'",",")+2, strlen("`c'")
> ) 
185.             local state_short = substr("`state'",1,2)
186.             local state_long = substr("`state'", strpos("`state'", ",")+2,
>  strlen("`state'"))
187.             local city_state = substr("`c'",1, strpos("`c'", ",")+3)
188.             local city_statelon = "`city_name'" + ", " + "`state_long'"
189.             qui replace country = "United States" if strpos(affiliation, "
> `city_state'") > 0 & country == ""
190.             qui replace us_state = "`state_short'" if country == "United S
> tates" & strpos(affiliation, "`city_state'") > 0 & us_state== ""
191.             qui replace city = "`city_name'" if strpos(affiliation, "`city
> _state'") > 0 & country == "United States"
192.             qui replace country = "United States" if strpos(affiliation, "
> `city_statelon'") > 0 & country == ""
193.             qui replace us_state = "`state_short'" if country == "United S
> tates" & strpos(affiliation, "`city_statelon'") > 0 & us_state== ""
194.             qui replace city = "`city_name'" if strpos(affiliation, "`city
> _statelon'") > 0 & country == "United States"
195.             qui replace city = "`city_name'" if  strpos(affiliation, "`cit
> y_name'") > 0 & city == "" & us_state == "`state_short'" & !inlist("`city_nam
> e'", "Center", "University", "LA")
196.             local i = `i' + 1 
197.         }
198.         replace city = "New York" if strpos(affiliation, "New York, New Yo
> rk") > 0 | strpos(affiliation, "New York, NY") > 0 
199.         replace city = "Chevy Chase" if strpos(affiliation, "Chevy Chase")
>  > 0 & us_state == "MD" 
200.         replace city = "Stanford" if strpos(affiliation, "Stanford Univers
> ity") > 0 
201.         replace city = "Houston" if strpos(affiliation, "Anderson Cancer C
> enter") > 0  | strpos(affiliation, "M.D. Anderson") > 0 | strpos(affiliation,
>  "M. D. Anderson") > 0 | strpos(affiliation, "MD Anderson") > 0
202.         replace city = "Saint Louis" if strpos(affiliation, "Washington Un
> iversity") > 0 & strpos(affiliation, "Western Washington University") == 0 & 
> strpos(affiliation, "George Washington University") == 0
203.         replace city = "Saint Paul" if (strpos(affiliation, "St. Paul") | 
> strpos(affiliation, "St Paul")) > 0 & us_state == "MN" 
204.         replace city = "Saint Louis" if (strpos(affiliation, "St. Louis") 
> | strpos(affiliation, "St Louis")) > 0 & us_state == "MO" 
205.         replace city = "Princeton" if strpos(affiliation, "Princeton Unive
> rsity") > 0
206.         foreach s in `state_abbr' {
207.             replace us_state = "`s'" if country == "United States" & strpo
> s(affiliation, ", `s'") > 0 & mi(us_state)
208.         }
209.         // do zip
.         gen zip = ustrregexs(0) if ustrregexm(affiliation, "[0-9][0-9][0-9][0
> -9][0-9][\.]") & country == "United States"
210.         replace zip = ustrregexs(0) if ustrregexm(affiliation, "[0-9][0-9]
> [0-9][0-9][0-9][\-]") & country == "United States" & mi(zip)
211.         replace zip = ustrregexs(0) if ustrregexm(affiliation, "[0-9][0-9]
> [0-9][0-9][0-9][\,]") & country == "United States" & mi(zip)
212.         replace zip = ustrregexs(0) if ustrregexm(affiliation, "[a-zA-Z]+[
> \s][0-9][0-9][0-9][0-9][0-9][\,]") & country == "United States" & mi(zip)
213.         qui gen zip_len = strlen(zip) 
214.         assert zip_len == 0 | zip_len == 6
215.         replace zip =  substr(zip, 1, strlen(zip)-1)
216.         replace zip = "92093" if zip == "02093"
217.         replace zip = "92037" if zip == "10010" & strpos(affiliation , "No
> rth Torrey Pines Road")> 0
218.         merge m:1 zip using  ../temp/list_zips, assert(1 2 3) keep(1 3) 
219.         replace us_state = state_zip if mi(us_state) & !mi(state_zip)
220.         replace country = "United States" if !mi(us_state)
221.         replace country = "United States" if mi(city) & !mi(city_zip)
222.         replace city = city_zip if mi(city) & !mi(city_zip)
223.         save ../temp/cleaned_uscities_`samp', replace
224.         *replace us_state = state_zip if !mi(zip) & _merge == 3 
.         *replace city = city_zip if !mi(zip) & _merge == 3
.         // world cities
.         foreach c in `big_country' {
225.             local city_name = substr("`c'", 1, strpos("`c'",",")-1)
226.             local country_name = substr("`c'", strpos("`c'",",")+2, strlen
> ("`c'")) 
227.             replace country = "`country_name'" if strpos(affiliation, "`c'
> ") > 0 & country == ""
228.             replace city = "`city_name'" if strpos(affiliation, "`c'") > 0
>  & city == ""
229.             replace city = "`city_name'" if  strpos(affiliation, "`city_na
> me'") > 0 & city == "" & country == "`country_name'" 
230.         }
231.         
.         // US fixes
.         replace city= "Philadelphia" if strpos(affiliation , "University of P
> ennsylvania")>0
232.         replace city = "University Park" if strpos(affiliation, "Pennsylva
> nia State University") > 0
233.         replace city = "King of Prussia" if strpos(affiliation, "King of P
> russia, Pennsylvania") > 0
234.         replace city = "West Point" if strpos(affiliation, "West Point, Pe
> nnsylvania") >0
235.         replace city = "Philadelphia" if strpos(affiliation, "Philadelphia
> , Pennsylvania") > 0 | (strpos(affiliation, "Philadelphia") > 0 & us_state ==
>  "PA")
236.         replace city = "Piitsburgh" if strpos(affiliation, "Pittsburgh, Pe
> nnsylvania") > 0
237.         // UK fixes
.         replace city = "Cambridge" if strpos(affiliation, "Cambridge, UK") > 
> 0
238.         replace country = "United Kingdom" if strpos(affiliation, "Cambrid
> ge, UK") > 0
239.         replace country = "United Kingdom" if strpos(affiliation, "Univers
> ity of Cambridge") > 0
240.         replace city = "Cambridge" if strpos(affiliation, "University of C
> ambridge") > 0
241.         replace city = "Hinxton" if strpos(affiliation, "Hinxton") > 0 & m
> i(city)
242.         replace city = "Oxford" if strpos(affiliation, "Oxford, UK") > 0
243.         replace country = "United Kingdom" if strpos(affiliation, "Oxford,
>  UK") > 0
244.         replace country = "United Kingdom" if strpos(affiliation, "Univers
> ity of Oxford") > 0
245.         replace city = "Oxford" if strpos(affiliation, "University of Oxfo
> rd") > 0
246.         replace city = "London" if strpos(affiliation, "London") > 0 & str
> pos(affiliation, "UK") >0 & mi(city)
247.         replace city = "Edinburgh" if strpos(affiliation, "Edinburgh") > 0
>   & country == "United Kingdom" & mi(city)
248.         replace city = "Glasgow" if strpos(affiliation, "Glasgow") > 0 & c
> ountry == "United Kingdom" & mi(city)
249.         
.         //Germany fixes
.         replace city = "Cologne" if strpos(affiliation, "Cologne, Germany") >
>  0  & mi(city)
250.         replace city = "Garching bei Munchen" if strpos(affiliation, "Garc
> hing") > 0 & mi(city)
251.         replace city = "Martinsried" if strpos(affiliation, "Martinsried")
>  > 0 & mi(city)
252.         replace city = "Oberpfaffenhofen" if strpos(affiliation, "Oberpfaf
> fenhofen, Germany") > 0 
253.         replace city = "Munich" if strpos(affiliation, "Munchen") > 0 & co
> untry == "Germany"
254.         replace city = "Munich" if strpos(affiliation, "Neuherberg") > 0 &
>  country == "Germany"
255.         replace city = "Munich" if strpos(affiliation, "Muenchen") > 0 & c
> ountry == "Germany"
256.         replace city = "Walldof" if strpos(affiliation, "Walldorf") > 0 & 
> country == "Germany"
257.         replace city = "Gottingen" if strpos(affiliation, "Goettingen") > 
> 0 & country == "Germany"
258.         replace city = "Ludwigshafen" if strpos(affiliation, "Ludwigshafen
> ") > 0 & country == "Germany"
259.         replace city = "Frankfurt" if strpos(affiliation, "Frankfurt") > 0
>  & country == "Germany"
260.         replace city = "Marburg" if strpos(affiliation, "Marburg") > 0 & c
> ountry == "Germany"
261.         replace city = "Munster" if strpos(affiliation, "Muenster") > 0 & 
> country == "Germany"
262.         replace city = "Stechlin" if strpos(affiliation, "Stechlin") > 0 &
>  country == "Germany"
263.         replace city = "Giessen" if strpos(affiliation, "Giessen") > 0 & c
> ountry == "Germany"
264.         replace city = "Tuebingen" if strpos(affiliation, "Tuebingen") > 0
>  & country == "Germany"
265.         replace city = "Julich" if strpos(affiliation, "Juelich") > 0 & co
> untry == "Germany"
266.         replace city = "Biberach" if strpos(affiliation, "Biberach") > 0 &
>  country == "Germany"
267. 
.         // other
.         replace city = "Tel Aviv" if strpos(affiliation, "Tel-Aviv") > 0 
268.         replace city = "Heidelberg" if strpos(affiliation, "Heidelberg") >
> 0 | strpos(affiliation, "Heidleberg") > 0
269.         replace city = "Milano" if strpos(affiliation, "Milan")  & country
>  == "Italy"
270.         replace city = "Aarhus" if strpos(affiliation, "Aarhus") > 0 & cou
> ntry == "Denmark" & mi(city)
271.         replace city = "Crete" if strpos(affiliation, "Crete, Greece") > 0
>  
272.         replace city = "Montreal" if strpos(affiliation, "Montreal") > 0 &
>  country == "Canada"
273.         replace city = "Geneva" if strpos(affiliation, "Geneva") > 0 & cou
> ntry == "Switzerland"
274.         save ../temp/cleaned_cities_`samp', replace
275.     }
276.     di "done clean cities"
277. 
.     qui {
278.         use ../temp/cleaned_cities_`samp', replace 
279.         gen institution = ""
280.         foreach i in `institutions' {
281.             if !inlist("`i'", "University of Texas", "Broad Institute of M
> IT and Harvard", "Howard Hughes Medical Institute") {
282.                 cap replace institution = "`i'" if strpos(affiliation, "`i
> '") > 0 & institution == ""
283.             }
284.         }
285.         gen broad_affl  = 1 if strpos(affiliation, "Broad Institute of MIT
>  and Harvard") > 0 | strpos(affiliation, "Broad Institute") > 0
286.         replace institution = "Broad" if broad_affl == 1
287.         gen hmmi_affl  = 1 if strpos(affiliation, "Howard Hughes Medical I
> nstitute") > 0 | strpos(affiliation, "HHMI") > 0
288.         
.         // US institutions
.         replace institution = "Harvard University" if strpos(affiliation, "Ha
> rvard") > 0 & country == "United States"
289.         replace institution = "Dana Farber Cancer Institute" if strpos(aff
> iliation, "Dana-Farber") > 0 | strpos(affiliation, "Dana Farber") > 0
290.         replace city = "Boston" if institution == "Dana Farber Cancer Inst
> itute"
291.         replace institution = "Indiana University" if strpos(affiliation, 
> "Indiana University") > 0
292.         replace institution = "University of Minnesota" if strpos(affiliat
> ion, "University of Minnesota") > 0
293.         replace institution = "University of Wisonsin, Madison" if strpos(
> affiliation, "University of Wisconsin")>0 & city == "Madison" & mi(institutio
> n)
294.         replace institution = "University of Wisonsin, Oshkosh" if strpos(
> affiliation, "University of Wisconsin")>0 & city == "Oshkosh" & mi(institutio
> n)
295.         replace institution = "University of Alaska, Fairbanks" if strpos(
> affiliation, "University of Alaska") > 0 & strpos(affiliation, "Fairbanks") >
>  0
296.         replace institution = "University of Nevada, Reno" if strpos(affil
> iation, "University of Nevada") > 0 & strpos(affiliation, "Reno") > 0
297.         replace institution = "University of Missouri" if strpos(affiliati
> on, "University of Missouri") > 0 
298.         replace institution = "University Hospitals Cleveland Medical Cent
> er" if strpos(affiliation, "Cleveland") > 0 & strpos(affiliation,"University 
> Hospitals") > 0
299.         replace institution = "University of Wisconsin, Milwaukee" if strp
> os(affiliation, "University of Wisconsin")>0 & city == "Milwaukee" & mi(insti
> tution)
300.         replace institution = "Stanford University" if strpos(affiliation,
>  "Stanford") > 0 & country == "United States"
301.         replace institution = "Yale University" if strpos(affiliation, "Ya
> le") > 0 & country == "United States"
302.         replace institution = "Johns Hopkins University" if strpos(affilia
> tion, "Johns") > 0 & strpos(affiliation, "Hopkins") > 0 & city == "Baltimore"
303.         replace institution = "Cornell University" if strpos(affiliation, 
> "Cornell")>0 & us_state == "NY"
304. 
.         replace institution = "Boston Children's Hospital" if strpos(affiliat
> ion, "Boston") > 0 & strpos(affiliation, "Children's")>0 & strpos(affiliation
> , "Hospital")>0
305.         replace institution = "Institute for Integrative Genome Biology" i
> f strpos(affiliation ,"Institute for Integrative Genome Biology")> 0
306.         replace institution = "Allen Institute" if strpos(affiliation, "Al
> len") > 0 & strpos(affiliation, "Seattle")> 0 
307.         replace institution = "Manus Biosynthesis" if strpos(affiliation, 
> "Manus Biosynthesis") >0
308.         replace institution = "Rutgers Univeristy" if inlist(institution, 
> "Rutgers, The State University of New Jersey", "Rutgers, The State University
>  of New Jersey - Camden", "Rutgers, The State University of New Jersey - Newa
> rk")
309.         replace institution = "Rutgers University" if strpos(affiliation, 
> "Rutgers") > 0 & mi(institution) & us_state == "NJ"
310.         replace institution = "University of Hawaii, Manoa" if strpos(affi
> liation, "University of Hawai") > 0 & (strpos(affiliation, "noa")>0) & us_sta
> te == "HI"
311.         replace institution = "University of Hawaii, Hanolulu" if strpos(a
> ffiliation, "University of Hawai") > 0 & (strpos(affiliation, "Honolulu")>0) 
> & us_state == "HI"
312.         replace institution = "University of North Carolina at Chapel Hill
> " if strpos(affiliation, "University of North Carolina") > 0 & strpos(affilia
> tion, "Chapel Hill") > 0
313.         replace institution = "Memorial Sloan-Kettering Cancer Center" if 
> strpos(affiliation, "Memorial") > 0 & strpos(affiliation, "Sloan") > 0 & strp
> os(affiliation, "Kettering")>0 & us_state == "NY"
314.         replace institution = "Washington University in St. Louis" if strp
> os(affiliation, "Washington University") > 0 & city == "Saint Louis" 
315.         replace institution = "Stony Brook University" if strpos(affiliati
> on, "Stony Brook") > 0 & us_state == "NY"
316.         replace institution = "Regeneron" if strpos(affiliation, "Regenero
> n") > 0
317.         replace institution = "St. Jude Children's Research Hospital" if s
> trpos(affiliation, "Jude Children's Research Hospital") > 0 
318.         replace institution = "Verve Therapeutics" if strpos(affiliation, 
> "Verve Therapeutics") > 0 | (strpos(affiliation, "Verve")>0& city=="Cambridge
> ") 
319. 
.         replace institution = "Plexxikon Inc" if strpos(affiliation, "Plexxik
> on Inc") > 0
320.         replace institution = "FORMA Therapeutics" if strpos(affiliation, 
> "FORMA Therapeutics") > 0
321.         replace institution = "Amyris" if strpos(affiliation, "Amyris")> 0
>  & us_state == "CA"
322.         replace institution = "Duke University" if strpos(affiliation, "Du
> ke") > 0 & city == "Durham"
323.         replace institution = "Koch Institute" if strpos(affiliation, "Koc
> h Institute") & city == "Cambridge"
324.         replace institution = "University of California, San Francisco" if
>  strpos(affiliation, "Eli and Edythe Broad Center of Regeneration Medicine an
> d Stem Cell Research") > 0
325.         replace institution = "New York Genome Center" if strpos(affiliati
> on, "New York Genome Center") > 0 
326.         replace institution = "Vir Biotechnology" if strpos(affiliation, "
> Vir Biotechnology") > 0
327.         replace institution = "Genentech" if strpos(affiliation, "Genentec
> h")>0 & us_state == "CA"
328.         replace institution = "Vanderbilt University" if strpos(affiliatio
> n, "Vanderbilt") > 0 & us_state == "TN"
329.         replace institution = "The Rockefeller University" if strpos(affil
> iation, "Rockefeller University")>0 & us_state =="NY"
330.         replace institution = "University of Massachusetts, Amherst" if st
> rpos(affiliation, "University of Massachusetts") > 0 & strpos(affiliation, "A
> mherst") > 0 
331.         replace institution = "University of Massachusetts, Boston" if str
> pos(affiliation, "University of Massachusetts") > 0 & strpos(affiliation, "Bo
> ston") > 0 
332.         replace institution = "Boston Biomedical Research Institute" if st
> rpos(affiliation, "Boston Biomedical Research Institute") > 0
333.         replace institution = "Dartmouth" if strpos(affiliation, "Dartmout
> h") > 0 & us_state == "NH"
334.         replace institution = "SUNY Albany" if strpos(affiliation, "Univer
> sity at Albany") > 0 & us_state == "NY"
335.         replace institution = "University of Massachusetts Medical School"
>  if strpos(affiliation, "University of Massachusetts Medical") >0
336.         replace institution = "Oregon Health Sciences University" if strpo
> s(affiliation, "Health")>0 & strpos(affiliation, "Science") > 0 & strpos(affi
> liation, "University") > 0 & us_state == "OR"
337.         replace institution = "University of Alabama, Birmingham" if strpo
> s(affiliation, "University of Alabama")> 0& city == "Birmingham"
338.         replace institution = "New York University" if strpos(affiliation,
>  "NYU") > 0 & city == "New York"
339.         replace institution = "Virginia Tech" if strpos(affiliation, "Virg
> inia Tech")>0
340.         replace institution = "10X Genomics" if strpos(affiliation, "10x G
> enomics") >0 | strpos(affiliation, "10X Genomics") >0
341.         replace institution = "Johns Hopkins University" if strpos(affilia
> tion, "Lieber") > 0 & city == "Baltimore"
342.         replace institution = "Frederick National Laboratory" if strpos(af
> filiation, "Frederick National Laboratory") >0
343.         replace institution = "Facebook" if strpos(affiliation, "Facebook"
> ) >0
344.         replace institution = "Adrienne Helis Malvin Medical Research Foun
> dation" if strpos(affiliation, "Adrienne Helis Malvin Medical Research Founda
> tion") > 0
345.         replace institution = "Adimab" if strpos(affiliation, "Adimab") > 
> 0
346.         replace institution = "Aduro" if strpos(affiliation, "Aduro") > 0
347.         replace institution = "Agios" if strpos(affiliation, "Agios") >0
348.         replace institution = "Buck Institute" if strpos(affiliation, "Buc
> k Institute for Research on Aging")>0
349.         replace institution = "Brotman Baty Institute" if strpos(affiliati
> on, "Brotman Baty Institute") >0
350.         replace institution = "California Institute for Quantitative Biome
> dical Research" if strpos(affiliation, "California Institute for Quantitative
>  Biomedical Research")>0
351.         replace institution = "California Institute for Biomedical Researc
> h" if strpos(affiliation, "California Institute for Biomedical Research") >0
352.         replace institution = "California Institute for Regenerative Medic
> ine" if strpos(affiliation, "California Institute for Regenerative Medicine")
>  >0
353.         replace institution = "Feinstein Institute for Medical Research" i
> f strpos(affiliation, "Feinstein Institute for Medical Research") >0
354.         replace institution = "Van Andel Research Institute" if strpos(aff
> iliation, "Van Andel") > 0 & us_state == "MI"
355.         replace institution = "Wake Forest University" if strpos(affiliati
> on, "Wake Forest") > 0 & us_state == "NC"
356.         replace institution = "Seattle Children's Research Institute" if s
> trpos(affiliation, "Seattle Children's Research Institute") >0
357.         replace institution = "La Jolla Institute for Immunology" if strpo
> s(affiliation, "La Jolla Institute for Immunology")>0
358.         replace institution = "DeepMind" if strpos(affiliation, "DeepMind"
> )>0   
359.         replace institution = "NIH" if inlist(institution, "National Cance
> r Institute", "National Eye Institute", "National Heart, Lung, and Blood Inst
> itute", "National Human Genome Research Institute") | ///
>           inlist(institution, "National Institute on Aging", "National Instit
> ute on Alcohol Abuse and Alcoholism", "National Institute of Allergy and Infe
> ctious Diseases", "National Institute of Arthritis and Musculoskeletal and Sk
> in Diseases") | ///
>           inlist(institution, "National Institute of Biomedical Imaging and B
> ioengineering", "National Institute of Child Health and Human Development", "
> National Institue of Dental and Craniofacial Research") | ///
>           inlist(institution, "National Institute of Diabetes and Digestive a
> nd Kidney Diseases", "National Institute on Drug Abuse", "National Institute 
> of Environmental Health Sciences", "National Institute of General Medical Sci
> ences", "National Institute of Mental Health", "National Institute on Minorit
> y Health and Health Disparities") | ///
>           inlist(institution, "National Institute of Neurological Disorders a
> nd Stroke", "National Institute of Nursing Research", "National Library of Me
> dicine", "National Heart Lung and Blood Institute", "National Institutes of H
> ealth")
360.         replace institution = "NIH" if city == "Bethesda" & (strpos(affili
> ation, "NCI") > 0 | strpos(affiliation, "NHLBI") > 0 | strpos(affiliation, "N
> HGRI") > 0 | strpos(affiliation, "NIAID") > 0| strpos(affiliation, "NIAMS") >
> 0 | strpos(affiliation, "NIH") > 0 | strpos(affiliation, "National Heart, Lun
> g, and Blood Institute") > 0)
361.         replace institution = "NIH" if strpos(affiliation, "Bethesda") > 0
>  & (strpos(affiliation, "National") > 0 & strpos(affiliation, "Institute") > 
> 0) & strpos(affiliation, "Technology") == 0
362.         replace institution = "NIH" if strpos(affiliation, "MD") > 0 & (st
> rpos(affiliation, "NIH")> 0) & country== "United States"
363.         replace institution = "United States Army Research Institute of In
> fectious Diseases" if strpos(affiliation, "United States Army Research Instit
> ute of Infectious Diseases") > 0 | (strpos(affiliation, "USAMRIID")>0 & count
> ry == "United States")
364.         foreach u in "Department of Energy Joint Genome Institute" "Entasi
> s Therapeutics" "Rady Children's Institute for Genomic Medicine" {
365.             replace institution = "`u'" if strpos(affiliation, "`u'") > 0
366.         }
367.         replace institution = "University of Nebraska, Lincoln" if strpos(
> affiliation, "University of Nebraska") > 0 & strpos(affiliation, "Lincoln") >
>  0 
368.         replace institution = "Baylor College of Medicine" if strpos(affil
> iation, "BCM") > 0 & strpos(affiliation, "Houston") > 0
369.         replace institution = "Bristol-Myers Squibb" if strpos(affiliation
> , "Bristol") > 0 & strpos(affiliation, "Squibb") > 0
370.         replace institution = "J. David Gladstone Institutes" if strpos(af
> filiation, "Gladstone") > 0 & strpos(affiliation, "Institute") > 0 
371. 
.         replace institution = "University of Colorado, Boulder" if strpos(aff
> iliation, "University of Colorado") > 0 & strpos(affiliation, "Boulder") > 0
372.         replace institution = "University of Colorado, Aurora" if strpos(a
> ffiliation, "University of Colorado") > 0 & strpos(affiliation, "Aurora") > 0
373.         replace institution = "University of Coloardo Anschutz Medical Cam
> pus" if strpos(affiliation, "University of Colorado Anschutz Medical Campus")
>  > 0 | strpos(affiliation, "University of Colorado Health Science") > 0 | (st
> rpos(affiliation, "University of Colorado") > 0 & (strpos(affiliation, "Medic
> al") > 0 | strpos(affiliation, "Medicine")>0))
374.         replace institution = "University of Colorado, Denver" if strpos(a
> ffiliation, "University of Colorado") > 0 & strpos(affiliation, "Denver") > 0
375.         replace institution = "University of Michigan, Ann Arbor" if strpo
> s(affiliation, "University of Michigan") > 0 & city == "Ann Arbor"
376.         replace institution = "NorthShore University HealthSystem" if strp
> os(affiliation, "NorthShore University HealthSystem") > 0
377.         replace institution = "Louisiana State University" if strpos(affil
> iation, "Louisiana State University") > 0
378.         replace institution = "Pennsylvania State University" if strpos(af
> filiation, "Penn State") > 0 & us_state == "PA"
379.         replace institution = "Loyala University of Chicago" if strpos(aff
> iliation, "Loyala University") > 0 & us_state == "IL"
380.         replace institution = "University of California, Los Angeles" if s
> trpos(affiliation, "UCLA") > 0
381.         replace institution = "University of California, Santa Barbara" if
>  strpos(affiliation, "UCSB") > 0
382.         replace institution = "University of California, San Diego" if str
> pos(affiliation, "UCSD") > 0
383.         replace institution = "University of California, San Diego" if str
> pos(affiliation, "University") > 0 & strpos(affiliation, "California") > 0 & 
> city == "La Jolla"
384.         replace institution = "University of California, Santa Cruz" if st
> rpos(affiliation, "UCSC") > 0
385.         replace institution = "University of California, San Francisco" if
>  strpos(affiliation, "UCSF") > 0
386.         replace institution = "University of Southern California" if strpo
> s(affiliation, "USC") > 0 & us_state == "CA"
387.         replace city = "Los Angeles" if institution == "University of Sout
> hern California"
388.         foreach cal in "Berkeley" "Los Angeles" "Santa Barbara" "San Diego
> " "Davis" "Irvine" "Santa Cruz" "Riverside" "Merced" "San Francisco" {
389.             replace institution = "University of California, `cal'" if str
> pos(affiliation, "University of California `cal'") > 0
390.             replace institution = "University of California, `cal'" if str
> pos(affiliation, "University of California-`cal'") > 0
391.             replace institution = "University of California, `cal'" if str
> pos(affiliation, "University of California, `cal'") > 0
392.             replace institution = "University of California, `cal'" if str
> pos(affiliation, "University of California at `cal'") > 0
393.             replace institution = "University of California, `cal'" if str
> pos(affiliation, "UC `cal'") > 0
394.             replace institution = "University of California, `cal'" if str
> pos(affiliation, "University of California") > 0 & strpos(affiliation, "`cal'
> ")>0& mi(institution)
395.             replace country = "United States" if institution == "Universit
> y of California, `cal'"
396.             replace us_state = "CA" if institution == "University of Calif
> ornia, `cal'"
397.         }
398.         replace institution = "University of Texas, Medical Branch at Galv
> eston" if strpos(affiliation, "University of Texas")>0 & strpos(affiliation, 
> "Medical Branch")> 0 & strpos(affiliation, "Galveston")> 0
399.         replace institution = "University of Texas, Health Science Center 
> at Houston" if strpos(affiliation, "University of Texas")>0 & strpos(affiliat
> ion, "Health")> 0 & strpos(affiliation, "Houston")> 0
400.         replace institution = "University of Texas, Health Science Center 
> at San Antonio" if strpos(affiliation, "University of Texas")>0 & strpos(affi
> liation, "Health")> 0 & strpos(affiliation, "San Antonio")> 0
401.         replace institution = "University of Texas, Southwestern Medical C
> enter" if strpos(affiliation, "University of Texas") >0 & strpos(affiliation,
>  "Southwestern") >0
402.         foreach tex in "Arlington" "Southwestern Medical Center" "Austin" 
> "Dallas" "El Paso"  "Permian Basin" "Rio Grande Valley" "San Antonio" "Tyler"
>  {
403.             replace institution = "University of Texas, `tex'" if strpos(a
> ffiliation, "University of Texas `tex'") > 0
404.             replace institution = "University of Texas, `tex'" if strpos(a
> ffiliation, "University of Texas") > 0 & city == "`tex'"
405.             replace institution = "University of Texas, `tex'" if strpos(a
> ffiliation, "University of Texas at `tex'") > 0
406.             replace institution = "University of Texas, `tex'" if strpos(a
> ffiliation, "University of Texas, `tex'") > 0
407.             replace institution = "University of Texas, `tex'" if strpos(a
> ffiliation, "University of Texas-`tex'") > 0
408.             replace institution = "University of Texas, `tex'" if strpos(a
> ffiliation, "UT `tex'") > 0
409.             replace country = "United States" if institution == "Universit
> y of Texas, `tex'"
410.             replace us_state = "TX" if institution == "University of Texas
> , `tex'"
411.         }
412.         replace institution = "MD Anderson" if strpos(affiliation, "Anders
> on Cancer Center") > 0
413.         replace institution = "Brigham and Women's Hospital" if strpos(aff
> iliation, "Brigham") > 0 & strpos(affiliation, "Women") > 0 & strpos(affiliat
> ion, "Hospital") > 0 
414.         replace institution = "Massachusetts Institute of Technology" if s
> trpos(affiliation, "MIT") >0 & city == "Cambridge"
415.         replace institution = "Memorial Sloan-Kettering Cancer Center" if 
> strpos(affiliation, "Sloan") > 0 & strpos(affiliation, "Kettering")>0 & mi(in
> stitution)
416.         replace institution = "Scripps Research Institute" if strpos(affil
> iation, "Scripps")>0 & strpos(affiliation, "Research")>0 & mi(institution)
417.         replace institution = "University of Maine" if strpos(affiliation,
>  "University of Maine") > 0
418.         replace institution = "Moderna" if strpos(affiliation, "Moderna") 
> >0 & country == "United States"
419.         replace city = "Cambridge" if institution == "Moderna"
420.         replace us_state = "MA" if institution == "Moderna"
421.         
.         replace institution = "Children's Mercy Hospital" if strpos(affiliati
> on, "Children's Mercy Hospital") > 0 & country == "United States" & mi(instit
> ution)
422.         replace institution = "Johns Hopkins University" if strpos(affilia
> tion, "Johns Hopkins") > 0 & mi(institution)
423.         
.         // UK institutions
.         replace institution = "University College London" if strpos(affiliati
> on, "UCL") > 0 & city == "London"
424.         replace institution = "University College London" if strpos(affili
> ation, "University College London")> 0
425.         replace institution = "University of St. Andrews" if strpos(affili
> ation, "University of St Andrew") > 0
426.         replace institution = "University of Cambridge" if strpos(affiliat
> ion, "Cambridge University") > 0 & mi(institution)
427.         replace institution = "University of Oxford" if strpos(affiliation
> , "Oxford University") > 0 & mi(institution)
428.         replace institution = "University of Galway" if strpos(affiliation
> , "National University") > 0 & strpos(affiliation, "Galway") > 0 
429.         replace institution = "University of Exeter" if strpos(affiliation
> , "Exeter University") > 0 & mi(institution)
430.         replace institution = "Paul Scherrer Institute" if strpos(affiliat
> ion, "Paul Scherrer Institut") > 0 & mi(institution)
431.         replace institution = "Wellcome Trust" if strpos(affiliation, "Wel
> lcome") > 0 & country == "United Kingdom"
432.         replace institution = "Wellcome Genome Campus" if strpos(affiliati
> on, "Wellcome Trust Sanger Institute")> 0 | strpos(affiliation, "Sanger Insti
> tute")>0
433.         replace institution = "Wellcome Genome Campus" if strpos(affiliati
> on, "Genome Campus")> 0 & strpos(affiliation, "Wellcome")>0
434.         replace institution = "University of Cambridge" if strpos(affiliat
> ion, "University of Cambridge") > 0 
435.         replace institution = "University of Cambridge" if strpos(affiliat
> ion, "Wellcome Trust-MRC Cambridge Stem Cell Institute") > 0 
436.         replace institution = "University of Cambridge" if strpos(affiliat
> ion, "Wellcome Trust-Medical Research Council Cambridge Stem Cell Institute")
>  > 0 
437.         replace institution = "University of Cambridge" if strpos(affiliat
> ion, "Wellcome Trust-MRC Institute of Metabolic Science") > 0 
438.         replace institution = "University of Edinburgh" if strpos(affiliat
> ion, "University of Edinburgh")>0
439.         replace institution = "University of Edinburgh" if strpos(affiliat
> ion, "Wellcome Trust Center for Cell Biology")>0
440.         replace institution = "University of Oxford" if strpos(affiliation
> , "University of Oxford")>0
441.         replace institution = "University of Oxford" if strpos(affiliation
> , "Wellcome Trust Centre for Human Genetics")>0
442.         replace institution = "University of Manchester" if strpos(affilia
> tion, "University of Manchester")> 0
443.             foreach uk in "John Innes Centre" "NIHR Cambridge Biomedical R
> esearch Centre" "NIHR Oxford Biomedical Research Centre" "Francis Crick Insti
> tute" "Natural History Museum" "Earlham Institute" "Imperial College" "Univer
> sity of Kent" "Babraham Institute" "Durham University" "Newcastle Hospitals N
> HS Foundation Trust" "Dundee University" "University of Galway" {
444.             replace institution = "`uk'" if strpos(affiliation, "`uk'") > 
> 0 & country == "United Kingdom"
445.         }
446.         replace city = "Galway" if institution == "University of Galway"
447. 
.         // Germany
.         foreach g in "Marburg" "Munich" "Bonn" "konstanz" "Munich" "Munster" 
> "Gottingen" "Cologne" "Frankfurt" "Giessen" "Tuebingen" "Wurzburg" "Heidelber
> g" "Hohenheim" "Freiburg" {
448.             replace institution = "University of `g'" if strpos(affiliatio
> n, "Universit") > 0 & strpos(affiliation, "`g'") > 0 & strpos(affiliation, "G
> ermany") > 0
449.             replace city = "`g'" if strpos(affiliation, "`g'") > 0 & strpo
> s(affiliation, "Germany") > 0
450.             replace country = "Germany" if strpos(affiliation, "Germany") 
> > 0
451.         }
452.         replace institution = "University of Munich" if (strpos(affiliatio
> n, "Philipps") > 0 | strpos(affiliation, "Phillipps") > 0 ) & strpos(affiliat
> ion, "Marburg")>0 & strpos(affiliation, "Universit") > 0 & mi(institution)
453.         replace institution = "University of Giessen" if strpos(affiliatio
> n, "Justus") > 0 & strpos(affiliation, "Liebig")>0 & strpos(affiliation, "Uni
> versit") > 0 & mi(institution)
454.         replace institution = "University of Munich" if strpos(affiliation
> , "LMU Munchen")> 0 & city == "Munich" & mi(institution)
455.         replace institution = "Goethe University" if strpos(affiliation, "
> Universit")> 0 & strpos(affiliation, "Goethe") & mi(institution)
456.         replace institution = "Univeristy of Gottingen" if strpos(affiliat
> ion, "Universit")> 0 & city == "Gottingen" & mi(institution)
457.         replace institution = "University of Tuebingen" if strpos(affiliat
> ion, "Universit") > 0 & city == "Tubingen" & country == "Germany" & mi(instit
> ution)
458.         replace institution = "University of Wurzburg" if strpos(affiliati
> on, "Universit") > 0 & city == "Wuerzburg" & country == "Germany" & mi(instit
> ution)
459.         replace institution = "University of Freiburg" if strpos(affiliati
> on, "Albert") > 0 & strpos(affiliation, "Ludwigs")>0 & strpos(affiliation, "F
> reiburg")>0
460.         replace institution = "Freie Universitat Berlin" if strpos(affilia
> tion, "Freie Universitat Berlin") > 0 | (strpos(affiliation, "Berlin")>0 & st
> rpos(affiliation, "FU")>0)
461.         replace institution = "FAU" if strpos(affiliation, "FAU") > 0 & st
> rpos(affiliation, "Germany") > 0 | (strpos(affiliation, "Friedrich") > 0 & st
> rpos(affiliation, "Alexander")>0)
462.         replace institution = "Charite-Universitatsmedizin Berlin" if strp
> os(affiliation, "Charite") > 0 & strpos(affiliation, "Universitatsmedizin") >
>  0 & strpos(affiliation, "Berlin") > 0
463.         replace institution = "RWTH Aachen University" if (strpos(affiliat
> ion, "RWTH") > 0 & strpos(affiliation, "Aachen") > 0)
464.         replace institution = "Johannes Gutenberg University Mainz" if str
> pos(affiliation, "Gutenberg") > 0 & strpos(affiliation, "Universit") > 0 & st
> rpos(affiliation, "Mainz") > 0
465.         replace institution = "Martin-Luther-University Halle-Wittenberg" 
> if strpos(affiliation, "Universit") > 0 & strpos(affiliation, "Martin") > 0 &
>  strpos(affiliation, "Luther") > 0 
466.         replace institution = "Leipzig University" if strpos(affiliation, 
> "Leipzig") > 0 & strpos(affiliation, "Universit") > 0
467.         replace institution = "Humboldt University" if strpos(affiliation,
>  "Humboldt") > 0 & strpos(affiliation, "Universit") > 0 & strpos(affiliation,
>  "Berlin") > 0
468.         replace institution = "Technical University Dresden" if strpos(aff
> iliation, "Techni")>0 & strpos(affiliation, "Universit")> 0 & strpos(affiliat
> ion, "Dresden") > 0
469.         replace institution = "Technical University Berlin" if strpos(affi
> liation, "Techni")>0 & strpos(affiliation, "Universit")> 0 & strpos(affiliati
> on, "Berlin") > 0
470.         replace institution = "Technical University Darmstadt" if strpos(a
> ffiliation, "Techni")>0 & strpos(affiliation, "Universit")> 0 & (strpos(affil
> iation, "Darmstadt") > 0 )
471.         replace institution = "Technical University Dortmund" if strpos(af
> filiation, "Techni")>0 & strpos(affiliation, "Universit")> 0 & (strpos(affili
> ation, "Dortmund") > 0 )
472.         replace institution = "Technical University Braunnschweig" if strp
> os(affiliation, "Techni")>0 & strpos(affiliation, "Universit")> 0 & (strpos(a
> ffiliation, "Braunschweig") > 0 )
473.         replace institution = "Friedrich-Schiller-University Jena" if strp
> os(affiliation, "Friedrich") > 0 & strpos(affiliation, "Schiller")>0 & strpos
> (affiliation, "Universit")  > 0
474.         replace institution = "Friedrich-Schiller-University Jena" if strp
> os(affiliation, "Universit")> 0  & strpos(affiliation, "Jena")  > 0
475.         replace institution = "Comprehensive Pneumology Center" if strpos(
> affiliation, "Comprehensive Pneumology Center")> 0 & city == "Munich" & mi(in
> stitution)
476.         replace institution = "Research Centre Julich" if strpos(affiliati
> on, "Research") > 0 & (strpos(affiliation, "Center") > 0 | strpos(affiliation
> , "Centre") > 0 ) & city == "Julich"
477.         replace city = "Cologne" if institution == "University of Cologne"
478.         replace institution = "Center for Synthetic Microbiology" if strpo
> s(affiliation, "Center for Synthetic Microbiology") > 0 & country == "Germany
> " & mi(institution)
479.         replace institution = "German Center for Diabetes Research" if str
> pos(affiliation, "German Center for Diabetes Research") > 0 & country == "Ger
> many"
480.         replace institution = "German Center for Neurodegenerative Disease
> " if strpos(affiliation, "German Center for Neurodegenerative Disease") > 0 &
>  country == "Germany"
481.         replace institution = "Helmholtz Munich" if strpos(affiliation, "H
> elmholtz") > 0 & city == "Munich" & country == "Germany"
482.         replace institution = "Heinrich Heine University" if strpos(affili
> ation, "Heinrich") > 0 & strpos(affiliation, "Heine") > 0 & strpos(affiliatio
> n, "Universit") >  0 & country == "Germany"
483.         replace institution = "European Neuroscience Institute" if strpos(
> affiliation, "European Neuroscience Institute") > 0
484.         replace institution = "European Molecular Biology Laboratory" if s
> trpos(affiliation, "European Molecular Biology Laboratory") > 0
485.         replace institution = "BC Cancer Research Centre" if strpos(affili
> ation, "BC Cancer Research Centre") > 0 
486.         replace city = "Vancouver" if institution == "BC Cancer Research C
> entre"
487.         replace institution = "DESY" if (strpos(affiliation, "Deutsches El
> ektronen-Synchrotron") > 0 | strpos(affiliation, "DESY") > 0) & country == "G
> ermany"
488.         replace institution = "Monash Biomedicine Discovery Institute" if 
> strpos(affiliation, "Monash Biomedicine Discovery Institute") > 0 
489.         replace institution = "DKFZ" if (strpos(affiliation, "German Cance
> r Research Center")> 0 | strpos(affiliation, "DKFZ") > 0) & country == "Germa
> ny"
490.         replace institution = "Autism CRC" if (strpos(affiliation, "Cooper
> ative Research Centre for Living with Autism")>0 | strpos(affiliation, "Autis
> m CRC")>0) & country == "Australia" 
491.         replace institution = "Senckenberg Society for Nature Research" if
>  strpos(affiliation, "Senckenberg") > 0  & strpos(affiliation, "Naturforschun
> g") > 0 
492.         replace institution = "Technical University of Munich" if strpos(a
> ffiliation, "Technical University of Munich") > 0
493.         replace institution = "iDiv" if strpos(affiliation, "German Centre
>  for Integrative Biodiversity Research") > 0
494.         replace institution = "LIPM" if strpos(affiliation, "LIPM") > 0 & 
> country == "France"
495.         replace institution = "Boehringer-Ingelheim Pharma" if strpos(affi
> liation, "Boehringer-Ingelheim Pharma") > 0 
496.         replace city = "Dusseldorf" if institution == "Heinrich Heine Univ
> ersity"
497.         replace institution = "IMT" if strpos(affiliation, "Institut") > 0
>  & strpos(affiliation, "Molekularbiologie") > 0 & strpos(affiliation, "Tumorf
> orschung") & city == "Marburg"
498.         replace institution = "IPK" if strpos(affiliation, "Leibniz Instit
> ute of Plant Genetics and Crop Plant Research") > 0
499.         replace institution = "ZALF" if strpos(affiliation, "Leibniz Centr
> e for Agricultural Landscape Research") > 0
500.         replace institution = "Google" if strpos(affiliation, "Google") > 
> 0
501.         replace institution = "Medical Research Council" if strpos(affilia
> tion, "MRC ") > 0 & country == "United Kingdom" & mi(institution)
502.         replace institution = "Weizmann Institute of Science" if strpos(af
> filiation, "Weizmann") > 0 & country == "Israel" & mi(institution)
503.         replace institution = "Katholieke Universiteit Leuven" if strpos(a
> ffiliation, "KU Leuven") > 0
504.        
.        //french uni
.         foreach f in "Montpellier" "Nantes" "Strasbourg" "Toulouse" "Tours" "
> Bordeaux" "Lyon" "Lille" "Bourgogne"  "Lorraine" "Paris" "Toulon" "Picardie J
> ules Verne" "Franche-Comte" "Versailles" "Nice" "la Reunion" "Rennes" "Poitie
> rs" {
505.             replace institution = "Universite de `f'" if strpos(affiliatio
> n, "Universite") > 0 & strpos(affiliation, "`f'") > 0 
506.             replace institution = "Universite de `f'" if strpos(affiliatio
> n, "Univ") > 0 & strpos(affiliation, "`f'") > 0 
507.             replace city = "`f'" if strpos(affiliation, "`f'") > 0 & mi(ci
> ty)
508.             replace country = "France" if strpos(affiliation, "`f'") > 0 &
>  mi(country)
509.         }
510.         foreach f in "Sorbonne Universite" "Universite Grenoble Alpes" "Un
> iversite Cote d'Azur" "Universite Paul Sabatier" "Universite d'Evry" "Univers
> ite Clermont Auvergne" "Aix Marseille Universite" "University Paris Descartes
> " "Turing Centre for Living Systems" "INSERM" "CNRS" "Institut Pasteur"  "Sci
> ences Po" {
511.             replace institution = "`f'" if strpos(affiliation, "`f'")>0  &
>  strpos(affiliation, "France") > 0
512.         }
513.         replace institution = "Aix Marseille Universite" if strpos(affilia
> tion, "Aix") > 0 & strpos(affiliation, "Marseille")>0 & strpos(affiliation,"U
> niv")>0
514.         replace institution = "Universite Grenoble Alpes" if strpos(affili
> ation, "Grenoble") > 0 & strpos(affiliation, "Alpes")>0 & strpos(affiliation,
> "Univ")>0
515.         replace institution = "INSERM" if strpos(affiliation, "Inserm") > 
> 0
516.         replace institution = "Ecole Polytechnique Federale de Lausanne" i
> f strpos(affiliation, "Lausanne") >0 & strpos(affiliation, "polytechnique") >
>  0 
517. 
.         // other
.         replace institution = "Shaukat Khanum Memorial Cancer Hospital and Re
> search Center" if strpos(affiliation, "Shaukat Khanum Memorial Cancer Hospita
> l and Research Center") > 0 & mi(institution)
518.         replace institution = "Alexandrov Research Institute of Oncology a
> nd Medical Radiology" if strpos(affiliation, "Alexandrov Research Institute o
> f Oncology and Medical Radiology") > 0 & country == "Belarus"
519.         replace institution = "Private University in the Principality of L
> iechtenstein" if strpos(affiliation, "Private University in the Principality 
> of Liechtenstein") > 0 
520.         replace institution = "Research Institute of Molecullar Pathology"
>  if strpos(affiliation, "Research Institute of Molecular Pathology") > 0
521.         replace institution = "MDC" if strpos(affiliation, "Max Delbruck C
> enter for Molecular Medicine") > 0 | (strpos(affiliation, "MDC") & country ==
>  "Germany")
522.         replace institution = "University of Zurich" if strpos(affiliation
> , "Universit") > 0 & strpos(affiliation, "Zurich") > 0  & country == "Switzer
> land"
523.         replace institution = "Tsinghua-Peking Center for Life Sciences" i
> f strpos(affiliation, "Tsinghua-Peking Center for Life Sciences") > 0
524.         replace institution = "Altius Institute for Biomedical Sciences" i
> f strpos(affiliation, "Altius Institute for Biomedical Sciences") >0
525.         replace institution = "Bin Talal Bin Abdulaziz Alsaud Institute fo
> r Computational Biomedicine" if strpos(affiliation, "Bin Talal Bin Abdulaziz 
> Alsaud Institute for Computational Biomedicine") > 0
526.         replace institution = "BGI-Shenzhen" if strpos(affiliation, "BGI-S
> henzhen") > 0 
527.         replace institution = "Heptares Therapeutics" if strpos(affiliatio
> n, "Heptares Therapeutics") >0 
528.         replace institution = "University of Western Sydney" if strpos(aff
> iliation, "Western Sydney University") >0
529.         replace institution = "CeMM Research Center for Molecular Medicine
>  of the Austrian Academy of Sciences" if strpos(affiliation, "CeMM Research C
> enter for Molecular Medicine of the Austrian Academy of Sciences") > 0
530.         replace institution = "RIKEN" if strpos(affiliation, "RIKEN") > 0 
> & country == "Japan"
531.         replace city = "Shenzhen" if institution == "BGI-Shenzhen"
532.         replace institution = "VIB" if strpos(affiliation, "VIB") > 0 & co
> untry == "Belgium"
533.         replace institution = "ETH Zurich" if strpos(affiliation, "ETH Zur
> ich") > 0
534.         replace institution = "IMBA" if strpos(affiliation, "Institute of 
> Molecular Biotechnology of the Austrian Academy of Sciences") | strpos(affili
> ation, "IMBA") > 0  & country == "Austria"
535.         replace institution = "Radboud University Nijmegen" if strpos(affi
> liation, "Radboud University") > 0 
536.         replace institution = "BBIB" if strpos(affiliation, "Berlin-Brande
> nburg Institute of Advanced Biodiversity Research") > 0 | (strpos(affiliation
> , "BBIB") & strpos(affiliation, "Germany") > 0 )
537.         replace institution = "Hebrew University of Jerusalem" if strpos(a
> ffiliation, "Hebrew University") > 0 & city == "Jerusalem" & mi(institution)
538.         replace institution = "CDC" if strpos(affiliation, "Centers for Di
> sease Control") & country == "United States"
539.         replace city = "Atlanta" if institution == "CDC" & mi(city)
540.         // fill in random unis
.         qui glevelsof city, local(found_cities)
541.         foreach c in `found_cities' {
542.             replace institution = "University of `c'" if strpos(affiliatio
> n, "University of `c'") > 0 & city == "`c'" & mi(institution)
543.         }
544.         
.         // random biotech
.         replace institution = "Novartis" if pmid == 28753431
545.         replace institution = "Bernhard-Nocht-Institute" if strpos(affilia
> tion, "Bernhard") > 0 & strpos(affiliation, "Nocht")> 0 & strpos(affiliation,
>  "Institute")>0
546. 
.         foreach i in "Bundeswehr" "Irrua Specialist Teaching Hospital" "Bioqu
> al" "Institute for Health Metrics and Evaluation" "National Institute of Publ
> ic Health" "African Population and Health Research Center" ///
>               "Chinese Center for Disease Control and Prevention" "London Sch
> ool of Hygiene & Tropical Medicine" "Alcohol, Drug Abuse, and Mental Health A
> dministration" "Hopital Beaujon" ///
>               "Institute for Research in Biomedicine" "St Bartholomew's Hospi
> tal" "Institute of Bioinformatics" "Basel Institute for Immunology" "Beijing 
> Genomics Institute" "NHS Blood and Transplant" ///
>               "Polyphor AG" "Denali Therapeutics" "Gustave Roussy Cancer Camp
> us" "Lustgarten Foundation Pancreatic Cancer Research Laboratory" "BioNTech" 
> "PTC Therapeutics" "deCODE Genetics" ///
>               "Africa Health Research Institute" "German Center for Infection
>  Research" "QIMR Berghofer Medical Research Institute" "Army Medical Research
>  Institute of Infectious Diseases" "Biogen" ///
>               "The Cancer Cell Map Initiative" "Guangdong Provincial Center f
> or Disease Control and Prevention" "Neoleukin Therapeutics" "Beijing Proteome
>  Research Center" "Sun Yat-sen University" ///
>               "Academy for Scientific and Innovative Research" "Massachusetts
>  Department of Public Health" "Chinese Academy of Medical Sciences" "BC Cance
> r" "Global Virus Network" "KiTZ" ///
>               "Humanitas Clinical and Research Center" "Candiolo Cancer Insti
> tute" "Northwell Health" "National Centre for Disease Control" "Peter MacCall
> um Cancer Centre" "Cancer Cell Map Initiative"  ///
>               "Peter MacCallum Cancer Centre" "Cancer Therapeutics CRC" "IRCC
> S" "Infinity Pharmaceuticals" "Oncology Institute of Southern Switzerland" //
> /
>               "Walter and Eliza Hall Institute" "Guangdong Provincial Institu
> tion of Public Health" "Netherlands Cancer Institute" "Sinovac Biotech" "Sust
> ainable Sciences Institute" "University of Torino" ///
>               "Illumina" "innate Pharma" "Tel-Aviv University" "La Jolla Inst
> itute for Allergy and Immunology" "Kenema Government Hospital" "Public Health
>  Scotland" "Commonwealth Scientific and Industrial Research Organisation" ///
>               "Helmholtz Innovation Lab BaoBab" "National Centre for Infectio
> us Diseases" "Persiaran Institusi" "Environment and Climate Change Canada" "P
> eking University" "Lunenfeld-Tanenbaum Research Institute" "INGM" "FLI" ///
>               "Institut de Biologie Physico-Chimique" "Northeast Structural G
> enomics Consortium" "Community Research Advisors Group" "Salk Institute" "Isi
> s Pharmaceuticals" "A*STAR Institute of Medical Biology" ///
>               "AGIOS Pharmaceuticals" "AP-HP" "University and Hospital Trust 
> of Verona" "Duke-NUS Medical School" "Acuitas Therapeutics" "Adaptive Biotech
> nologies" "Aeras" "Alliance International for Medical Action" ///
>               "Almazov Federal Medical Research Centre" "BIOQUAL" "Baker Hear
> t & Diabetes Institute" "Baylor Genetics" "Baylor Institute for Immunology Re
> search" "Beijing Institute of Respiratory Medicine" ///
>               "Beijing Key Laboratory of New Molecular Diagnostics Technology
> " "Capital Medical University" "Benaroya Research Institute" "Berlin Institut
> e for Medical Systems Biology" ///
>               "Max Delbrueck Center for Molecular Medicine" "23andMe" "Vister
> ra Inc." "Vitalant Research Institute" "Tulane National Primate Research Cent
> er" "Aetna" "Tokyo Metropolitan Institute of Public Health" "Francis Crick In
> stitute" ///
>               "Argonne National Laboratory" "Washington State Department of H
> ealth" "Institute of Molecular Genetics of the Czech Academy of Sciences" "Ce
> ntre Hospitalier Universitaire de Treichville and Treichville University Hosp
> ital" {
547.                 replace institution = "`i'" if strpos(affiliation, "`i'")>
> 0 & mi(institution)
548.          }
549.         replace institution = institution + " " + country if institution =
> = "Ministry of Health" & !mi(country)
550.         replace institution = "Francis Crick Institute" if institution == 
> "The Francis Crick Institute"
551.         replace institution = "University of North Carolina at Chapel Hill
> " if strpos(affiliation, "University of North Carolina")> 0
552.         replace institution = "NHS Blood and Transplant" if strpos(affilia
> tion, "National Health Service Blood and Transplant")>0 & mi(institution)
553. 
.         replace institution = "Chinese Academy of Medical Sciences" if strpos
> (affiliation, "Peking Union Medical College")>0
554.         replace institution = "Chinese Academy of Sciences" if strpos(affi
> liation, "Institute of Basic Medical Sciences")>0
555.         replace institution = "INSERM" if strpos(affiliation, "National In
> stitute for Health and Medical Research")> 0
556.         replace institution = "University Medical Center Utrecht" if strpo
> s(affiliation, "University Medical Centre Utrecht")> 0
557.         replace institution = "Tel Aviv University" if institution == "Tel
> -Aviv University"
558.         replace institution = "University College London" if strpos(affili
> ation, "UCL")>0 & mi(institution)
559.         replace institution = "University of Hamburg" if strpos(affiliatio
> n, "Universitatsklinikum Hamburg")>0 
560.         replace institution = "University of Munich" if strpos(affiliation
> , "LMU Munich")>0  & mi(institution)
561.         replace institution = "University of Munich" if strpos(affiliation
> , "Ludwig Maximilians University")>0 & mi(institution)
562.         replace institution = "University of Munich" if strpos(affiliation
> , "Ludwig-Maximilians Universitat")>0 & mi(institution)
563.         replace institution = "Peking University" if strpos(affiliation, "
> Peking")>0 & strpos(affiliation, "University")>0
564.        // fill in locations of institutions 
.         merge m:1 institution using ../temp/unique_institutions, assert(1 2 3
> ) keep(1 3) nogen
565.         replace country = country_name if mi(country)
566.         drop country_name
567.         replace country = "United States" if institution == "NIH"
568.         replace city = "Cambridge" if institution == "Harvard University"
569.         replace us_state = "MA" if institution == "Harvard University"
570.         replace city = "New Haven" if institution == "Yale University"
571.         replace city = "Baltimore" if institution == "Johns Hopkins Univer
> sity"
572.         replace city = "Boston" if institution == "Massachusetts General H
> ospital"
573.         replace city = "Chicago" if institution == "University of Chicago"
574.         replace country = "China" if inlist(institution, "Chinese Academy 
> of Sciences", "Peking University")
575.         replace country = "United Kingdom" if institution == "University C
> ollege London"
576.         replace country = "Colombia" if institution == "Universidad Nacion
> al"
577.         replace country = "Nepal" if institution == "Agriculture and Fores
> try University" 
578.         replace city = "Rehovot" if institution == "Weizmann Institute of 
> Science"
579.         replace city = "Edinburgh" if institution == "University of Edinbu
> rgh"
580.         replace city = "Montreal" if institution == "McGill University"
581.         replace city = "Geneva" if institution == "University of Geneva"
582.         replace city = "Aarhus" if institution == "Aarhus University"
583.         replace city = "Exeter" if institution == "University of Exeter"
584.         replace city = "Cambridge" if institution == "University of Cambri
> dge"
585.         replace city = "Oxford" if institution == "University of Oxford"
586.         replace city = "Ghent" if institution == "Ghent University"
587.         replace city = "Melbourne" if institution == "Monash University"
588.         replace city = "Gothenburg" if institution == "University of Gothe
> nburg"
589.         replace city = "Dundee" if institution == "University of Dundee"
590.         replace city = "London" if institution == "Wellcome Trust"
591.         replace country = "United Kingdom" if institution == "Wellcome Tru
> st"
592.         replace institution = "University of Queensland" if institution ==
>  "The University of Queensland"
593.         replace city = "Brisbane" if institution == "University of Queensl
> and"
594.         replace city = "Glasgow" if institution == "University of Glasgow"
595.         replace city = "Bogota" if institution == "Universidad Nacional"
596.         replace city = "Villigen" if institution == "Paul Scherrer Institu
> te"
597.         replace country = "Switzerland" if institution == "Paul Scherrer I
> nstitute"
598.         replace city = "Parkville" if institution == "Walter and Eliza Hal
> l Institute of Medical Research"
599.         replace institution = "Max Planck" if strpos(affiliation, "Max Pla
> nck") > 0
600.         replace city = "St. Andrews" if institution == "University of St. 
> Andrews"
601.         replace country = "China" if institution == "Peking University"
602.         replace city = "Beijing" if institution == "Peking University" 
603.         replace country = "China" if strpos(affiliation, "PRC") & mi(count
> ry)
604.         replace country = "China" if strpos(affiliation, "P.R.C.") & mi(co
> untry)
605.         replace city = "Beijing" if strpos(affiliation, "Beijing")>0 & cou
> ntry == "China"
606.         replace city = "Xi'an" if strpos(affiliation, "Xi'An")>0 & country
>  == "China"
607.         replace city = "Xi'an" if strpos(affiliation, "Xi'an")>0 & country
>  == "China"
608.         replace city = "Hong Kong" if strpos(affiliation, "Hong Kong")>0
609.         replace country = "China" if city == "Hong Kong"
610.         replace city = "Yunnan" if strpos(affiliation, "Yunnan")>0 & count
> ry == "China"
611.         replace city = "Shanghai" if strpos(affiliation, "Shanghai")>0 & c
> ountry == "China"
612.         replace city = "Shandong" if strpos(affiliation, "Shandong")>0 & c
> ountry == "China"
613.         replace city = "Guangdong" if strpos(affiliation, "Guangdong")>0 &
>  country == "China"
614.         replace city = "Suzhou" if strpos(affiliation, "Suzhou")>0 & count
> ry == "China"
615.         replace city = "Xuzhou" if strpos(affiliation, "Xuzhou")>0 & count
> ry == "China"
616.         replace city = "Yangling" if strpos(affiliation, "Yangling")>0 & c
> ountry == "China"
617.         replace city = "Sichaun" if strpos(affiliation, "Sichuan")>0 & cou
> ntry == "China"
618.         replace city = "Changchun" if strpos(affiliation, "Changchun")>0 &
>  country == "China"
619.         replace country = "United Kingdom" if (strpos(affiliation, "London
> ")>0 | strpos(affiliation, "Glasgow") > 0 | strpos(affiliation, "Liverpool")>
> 0) & mi(country)
620.         replace city = "London" if strpos(affiliation, "London")>0 &countr
> y == "United Kingdom" 
621.         replace city = "Cambridge" if strpos(affiliation, "Cambridge")>0 &
>  mi(city)         
622.         replace city = "DC" if strpos(affiliation, "DC")>0 & mi(city) & co
> untry == "United States"
623.         replace city = "Boston" if strpos(affiliation, "Boston")>0 & mi(ci
> ty) & country == "United States"
624.         replace city = "Bethesda" if strpos(affiliation, "Bethesda")>0 & m
> i(city) & country == "United States"
625.         replace city = "Gig Harbor" if strpos(affiliation, "Gig Harbor")>0
>  & mi(city) & country == "United States"
626.         replace city = "Foster City" if strpos(affiliation, "Foster City")
> >0 & mi(city) & country == "United States"
627.         replace city = "New York" if strpos(affiliation, "NY")>0 & mi(city
> ) & country == "United States"
628.         replace city = "Saint Louis" if strpos(affiliation, "St Louis")>0 
> & mi(city) & country == "United States"
629.         replace city = "Saint Paul" if strpos(affiliation, "St Paul")>0 & 
> mi(city) & country == "United States"
630.         replace city = "Atlanta" if strpos(affiliation, "Atlanta")>0 & mi(
> city) & country == "United States"
631.         replace city = "Argonne" if strpos(affiliation, "Argonne")>0 & mi(
> city) & country == "United States"
632.         replace city = "Chapel Hill" if institution == "University of Nort
> h Carolina at Chapel Hill" 
633.         replace city = "Moscow" if strpos(affiliation, "Moscow")>0 & mi(ci
> ty) & country == "Russia"
634.         replace city = "Derio" if strpos(affiliation, "Derio")>0 & mi(city
> ) & country == "Spain"
635.         replace city = "Glasgow" if strpos(affiliation, "Glasgow")>0 & mi(
> city) & country == "United Kingdom"
636.         replace city = "Tarrytown" if strpos(affiliation, "Tarrytown")>0 &
>  mi(city) & country == "United States"
637.     }
638.     di "done clean institutions"
639. 
.     qui {
640.         // extras 
.         drop if pmid == 28445112
641.         drop if affiliation == "."
642.         gen is_lancet = strpos(affiliation, "The Lancet")>0
643.         gen is_london = (affiliation == "London." | affiliation == "London
> , UK.") & mi(institution)
644.         gen is_bmj = (strpos(affiliation, "BMJ")>0| strpos(affiliation, "B
> ritish Medical Journal")>0)  & mi(institution)
645.         gen is_jama = strpos(affiliation, "JAMA.")>0
646.         gen is_editor = strpos(affiliation, "Associate Editor")>0
647.         bys pmid: egen has_lancet = max(is_lancet)
648.         bys pmid: egen has_london = max(is_london)
649.         bys pmid: egen has_bmj = max(is_bmj)
650.         bys pmid: egen has_jama = max(is_jama)
651.         bys pmid: egen has_editor = max(is_jama)
652.         drop if has_lancet == 1 | has_london == 1 | has_bmj == 1 | has_jam
> a == 1 | has_editor == 1
653.         drop is_lancet is_london is_bmj is_jama is_editor has_lancet has_l
> ondon has_bmj has_jama has_editor
654.         compress , nocoalesce
655.         save ../output/cleaned_all_`samp', replace
656.         keep if inrange(date, td(01jan2015), td(31mar2022))
657.         save ../output/cleaned_last5yrs_`samp', replace
658.     }
659.     di "done extra edits and data saved"
660. end 

. ** 
. main
done clean_mesh
done clean_date
done clean_journal
done clean_pubtype
done clean_authors
done clean_affls
done reshape_mult_affiliations
done reshape_mesh_terms
Done creating xwalks
Done prepping clean_geo
done clean countries
done cleaned US states
done clean cities
done clean institutions
done extra edits and data saved
done clean_geo
done clean_mesh
done clean_date
done clean_journal
done clean_pubtype
done clean_authors
.dta file corrupt
    The file unexpectedly ended before it should have.
r(612);

end of do-file
r(612);
