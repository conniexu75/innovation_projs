--------------------------------------------------------------------------------
Makelog started: 2023-01-28 09:24:35
Working directory: /export/home/dor/cxu/innovation_projs/analysis/science_geo/cns_descriptives/code
--------------------------------------------------------------------------------
External links successfully created!

  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      17.0
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2021 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-STATA-PC        https://www.stata.com
                                   979-696-4600        stata@stata.com

Stata license: Unlimited-user 4-core , expiring 17 Nov 2023
Serial number: 501709306977
  Licensed to: Harvard Business School
               Research Computing

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 120,000; see help set_maxvar.

. do "/export/home/dor/cxu/innovation_projs/analysis/science_geo/cns_descriptiv
> es/code/analysis.do" 

. set more off

. clear all

. capture log close

. program drop _all

. set scheme modern

. pause on

. set seed 8975

. here, set
/export/home/dor/cxu/innovation_projs/analysis/science_geo/cns_descriptives/cod
> e/

. 
. program main
  1.     global country_name "countries"
  2.     global us_state_name "US states"
  3.     global area_name "US cities"
  4.     global city_full_name "world cities"
  5.     global inst_name "institutions"
  6.     foreach samp in cns {
  7.         di "OUTPUT START"
  8.         local samp_type = cond("`samp'" == "cns", "main", "robust")
  9.         *get_total_articles, samp(`samp') samp_type(`samp_type')
.         foreach data in fund { //dis thera {
 10.             foreach var in cite_affl_wt {
 11.                 athr_loc, data(`data') samp(`samp') wt_var(`var')
 12.                 qui trends, data(`data') samp(`samp') wt_var(`var')
 13.             }
 14.             calc_broad_hhmi, data(`data') samp(`samp') 
 15.             top_mesh_terms, data(`data') samp(`samp') samp_type(`samp_type
> ')
 16.             top_mesh_terms, data(trans) samp(`samp') samp_type(`samp_type'
> )
 17.             qui output_tables, data(`data') samp(`samp') 
 18.         }
 19.         foreach var in affl_wt cite_affl_wt {
 20.             *qui comp_w_fund, samp(`samp')  wt_var(`var')
.         }
 21.     }
 22. end

. 
. program athr_loc
  1.     syntax, data(str) samp(str)  wt_var(str)
  2.     local suf = cond("`wt_var'" == "cite_affl_wt", "_wt", "") 
  3.     use ../external/cleaned_samps/cleaned_last5yrs_`data'_`samp', clear
  4.     foreach loc in country city_full inst {
  5.         qui gunique pmid //which_athr //if !mi(affiliation)
  6.         local articles = r(unique)
  7.         qui sum `wt_var'
  8.         local total = round(r(sum))
  9.         assert `total' == `articles'
 10.         qui sum `wt_var' if !mi(`loc') 
 11.         local denom = r(sum) 
 12.         preserve
 13.         if inlist("`loc'", "us_state", "area") {
 14.             qui keep if country == "United States"
 15.         }
 16.         gcollapse (sum) `wt_var', by(`loc')
 17.         qui hashsort -`wt_var' 
 18.         qui gen perc = `wt_var' / `total' * 100
 19.         li if mi(`loc')
 20.         qui drop if mi(`loc')
 21.         qui gen cum_perc = sum(perc) 
 22.         qui count
 23.         local rank_end = min(r(N),20) 
 24.         li `loc' perc in 1/`rank_end'
 25.         di "Total articles: `total'"
 26.         mkmat perc cum_perc in 1/`rank_end', mat(top_`loc'_`samp'`suf')
 27.         mat top_`loc'_`data'_`samp' = nullmat(top_`loc'_`data'_`samp') , (
> top_`loc'_`samp'`suf')
 28.         qui levelsof `loc' in 1/2
 29.         global top2_`loc'_`data' "`r(levels)'"
 30.         if inlist("`loc'", "inst", "city_full") {
 31.             qui levelsof `loc' in 1/`rank_end'
 32.             global `loc'_`data' "`r(levels)'"
 33.         }
 34.         qui gen rank_grp = "first" if _n == 1
 35.         qui levelsof `loc' if _n == 1
 36.         global `loc'_first "`r(levels)'"
 37.         qui levelsof `loc' if _n == 2
 38.         global `loc'_second "`r(levels)'"
 39.         qui replace rank_grp = "second" if _n == 2
 40.         qui replace rank_grp = "rest of top 10" if inrange(_n,3,10)
 41.         qui replace rank_grp = "remaining" if mi(rank_grp)
 42.         keep `loc' rank_grp
 43.         qui save ../temp/`loc'_rank_`data'_`samp'`suf', replace
 44.         restore
 45.     }
 46. end

. 
. program calc_broad_hhmi
  1.    syntax, data(str) samp(str) 
  2.    use ../external/cleaned_samps/cleaned_last5yrs_`data'_`samp', clear
  3.    qui gunique pmid which_athr
  4.    local num_athrs = r(unique)
  5.    qui gunique pmid which_athr if country == "United States"
  6.    local num_athrs_US = r(unique)
  7.    foreach i in broad hhmi {
  8.        qui gunique pmid which_athr if has_`i'_affl == 1
  9.        local num_`i' = r(unique)
 10.        di `num_`i'' " authors of " `num_athrs' " are " "`i' affiliated or 
> " `num_`i''/`num_athrs'*100 " percent"
 11.        qui gunique pmid which_athr if has_`i'_affl == 1 & country == "Unit
> ed States"
 12.        local num_`i'_US = r(unique)
 13.        di `num_`i'_US' " US authors of " `num_athrs_US' " are " "`i' affil
> iated or " `num_`i'_US'/`num_athrs_US'*100 " percent"
 14.        // hhmi has to be us
.        preserve
 15.        keep if country == "United States"
 16.        qui gunique pmid which_athr if has_`i'_affl == 1 & inst == "Stanfor
> d University" 
 17.        local num_`i'_stanford = r(unique)
 18.        di `num_`i'_stanford' " stanford authors of " `num_`i'_US' " are " 
> "`i' affiliated or " `num_`i'_stanford'/`num_`i'_US'*100 " percent"
 19.        qui gunique pmid which_athr if has_`i'_affl == 1 & inst == "Harvard
>  University" 
 20.        local num_`i'_harvard = r(unique)
 21.        di `num_`i'_harvard' " harvard authors of " `num_`i'_US' " are " "`
> i' affiliated or " `num_`i'_harvard'/`num_`i'_US'*100 " percent"
 22.        restore
 23.        if "`i'" == "broad" {
 24.            qui count if  inlist(inst, "Harvard University", "Massachusetts
>  Institute of Technology", "Boston Children's Hospital", "Dana Farber Cancer 
> Institute", "Massachusetts General Hospital", "Brigham and Women's Hospital",
>  "Beth Israel Deaconess Medical Center")
 25.            if r(N) > 0 {
 26.                preserve
 27.                keep if inlist(inst, "Harvard University", "Massachusetts I
> nstitute of Technology", "Boston Children's Hospital", "Dana Farber Cancer In
> stitute", "Massachusetts General Hospital", "Brigham and Women's Hospital", "
> Beth Israel Deaconess Medical Center")
 28.                qui gunique pmid which_athr if has_`i'_affl == 1 
 29.                local num_athrs_broad = r(unique)
 30.                qui gunique pmid which_athr if has_`i'_affl == 1 & inst == 
> "Harvard University" 
 31.                local num_`i'_harvard = r(unique)
 32.                di `num_`i'_harvard' " harvard authors of " `num_athrs_broa
> d' " are " "`i' affiliated or " `num_`i'_harvard'/`num_athrs_broad'*100 " per
> cent"
 33.                qui gunique pmid which_athr if has_`i'_affl == 1 & inst == 
> "Massachusetts Institute of Technology" 
 34.                local num_`i'_mit= r(unique)
 35.                di `num_`i'_mit' " mit authors of " `num_athrs_broad' " are
>  " "`i' affiliated or " `num_`i'_mit'/`num_athrs_broad'*100 " percent"
 36.                restore 
 37.            }
 38.         }
 39.     }
 40. end

. 
. program trends
  1.     syntax, data(str) samp(str)  wt_var(str)
  2.     local suf = cond("`wt_var'" == "cite_affl_wt", "_wt", "") 
  3.     use ../external/cleaned_samps/cleaned_all_`data'_`samp', clear
  4.     qui bys pmid year: gen counter = _n == 1
  5.     qui bys year: egen tot_in_yr = total(counter)
  6.     foreach loc in country city_full inst {
  7.         preserve
  8.         qui merge m:1 `loc' using ../temp/`loc'_rank_`data'_`samp'`suf', a
> ssert(1 3) keep(1 3) nogen
  9.         qui sum year
 10.         local min_year = max(1988,r(min))
 11.         qui egen year_bin  = cut(year),  at(1988 1991 1993 1995 1997 1999 
> 2001 2003 2007 2009 2011 2013 2015 2017 2019 2021 2023)
 12.         keep if which_athr == 1
 13.         qui replace affl_wt = 1/num_affls
 14.         local year_var year_bin
 15.         qui bys pmid `year_var': replace counter = _n == 1
 16.         qui bys `year_var': egen tot_in_`year_var' = total(counter)
 17.         qui replace rank_grp = "remaining" if mi(rank_grp)
 18.         bys pmid: replace cite_count = . if _n !=1 
 19.         qui bys `year_var': egen tot_cites_in_`year_var' = total(cite_coun
> t)
 20.         replace cite_wt = cite_count/ tot_cites_in_`year_var' * tot_in_`ye
> ar_var'
 21.         hashsort pmid cite_wt
 22.         qui by pmid: replace cite_wt = cite_wt[_n-1] if mi(cite_wt)
 23.         replace cite_affl_wt = affl_wt * cite_wt
 24.         collapse (sum) `wt_var' (mean) tot_in_`year_var' (firstnm) `loc' ,
>  by(rank_grp `year_var')
 25.         qui gen perc = `wt_var'/tot_in_`year_var' * 100
 26.         qui bys `year_var': egen tot = sum(perc)
 27.         qui replace tot = round(tot)
 28.         assert tot==100
 29.         qui drop tot
 30.         label define rank_grp 1 ${`loc'_first} 2 ${`loc'_second} 3 "Rest o
> f the top 10 ${`loc'_name}" 4 "Remaining places"
 31.         label var rank_grp rank_grp
 32.         qui gen group = 1 if rank_grp == "first"
 33.         qui replace group = 2 if rank_grp == "second"
 34.         qui replace group = 3 if rank_grp == "rest of top 10" 
 35.         qui replace group = 4 if rank_grp == "remaining"
 36.         qui hashsort `year_var' -group
 37.         qui bys `year_var': gen stack_perc = sum(perc)
 38.         keep rank_grp `year_var' `loc' perc group stack_perc
 39.         local stacklines
 40.         qui xtset group `year_var' 
 41.         qui levelsof group, local(rank_grps)
 42.         local items = `r(r)'
 43.         foreach x of local rank_grps {
 44.            colorpalette HTML purple, n(`items') nograph
 45.            local stacklines `stacklines' area stack_perc `year_var' if gro
> up == `x', fcolor("`r(p`x')'") lcolor(black) lwidth(*0.2) || 
 46.         }
 47.         qui gen labely = . 
 48.         qui gen rev_group = -group
 49.         qui bys `year_var' (rev_group): replace labely = perc / 2 if group
>  == 4
 50.         qui bys `year_var' (rev_group): replace labely = perc/2 + perc[_n-
> 1] if group == 3
 51.         qui bys `year_var' (rev_group): replace labely = perc/2 + perc[_n-
> 1] + perc[_n-2] if group == 2
 52.         qui bys `year_var' (rev_group): replace labely = perc/2 + perc[_n-
> 1] + perc[_n-2] + perc[_n-3] if group == 1
 53.         qui gen labely_lab = "Everywhere else" if group == 4
 54.         qui replace labely_lab = "Rest of the top 10 ${`loc'_name}" if gro
> up == 3
 55.         qui replace labely_lab = ${`loc'_second} if group == 2
 56.         qui replace labely_lab = ${`loc'_first} if group == 1
 57.         qui replace labely_lab = subinstr(labely_lab, "United States", "US
> ", .)
 58.         qui replace labely_lab = subinstr(labely_lab, "United Kingdom", "U
> K", .)
 59.         qui sum `year_var'
 60.         replace `year_var' = 2022 if `year_var' == r(max)
 61.         graph tw `stacklines' (scatter labely `year_var' if `year_var' ==2
> 022, ms(smcircle) ///
>           msize(0.2) mcolor(black%40) mlabsize(vsmall) mlabcolor(black) mlabe
> l(labely_lab)), ///
>           ytitle("Share of Worldwide Fundamental Science Research Output", si
> ze(small)) xtitle("Year", size(small)) xlabel(`min_year'(2)2022, angle(45) la
> bsize(vsmall)) ylabel(0(10)100, labsize(vsmall)) ///
>           graphregion(margin(r+25)) plotregion(margin(zero)) ///
>           legend(off label(1 ${`loc'_first}) label(2 ${`loc'_second}) label(3
>  "Rest of the top 10 ${`loc'_name}") label(4 "Remaining places") ring(1) pos(
> 6) rows(2))
 62.         qui graph export ../output/figures/`loc'_stacked_`data'_`samp'`suf
> '.pdf , replace 
 63.         restore
 64.     }
 65. end 

. 
. program comp_w_fund
  1.     syntax, samp(str) wt_var(str)
  2.     local suf = cond("`wt_var'" == "cite_affl_wt", "_wt", "") 
  3.     foreach trans in nofund {
  4.          local fund_name "Fundamental Science"
  5.          if "`trans'" == "dis"  local `trans'_name "Disease"
  6.          if "`trans'" == "thera"  local `trans'_name "Therapeutics"
  7.          if "`trans'" == "nofund"  local `trans'_name "Disease + Therapeut
> ics"
  8.          foreach type in city_full inst {
  9.             qui {
 10.                 global top_20 : list global(`type'_fund) | global(`type'_`
> trans')
 11.                 use ../external/cleaned_samps/cleaned_last5yrs_fund_`samp'
> , clear
 12.                 gen type = "fund"
 13.                 append using ../external/cleaned_samps/cleaned_last5yrs_`t
> rans'_`samp'
 14.                 replace type = "trans" if mi(type)
 15.                 gen to_keep = 0
 16.                 foreach i of global top_20 {
 17.                     replace to_keep = 1 if `type' == "`i'" 
 18.                 }
 19.                 gcollapse (sum) `wt_var' (mean) to_keep, by(`type' type)
 20.                 qui sum `wt_var' if type == "fund"
 21.                 gen share = `wt_var'/round(r(sum))*100 if type == "fund"
 22.                 qui sum `wt_var' if type == "trans"
 23.                 replace share = `wt_var'/round(r(sum))*100 if type == "tra
> ns"
 24.                 drop if mi(`type')
 25.                 hashsort type -`wt_var'
 26.                 by type: gen rank = _n 
 27.                 keep if to_keep == 1
 28.                 qui sum rank
 29.                 local rank_lmt = r(max) 
 30.                 reshape wide `wt_var' rank share, i(`type') j(type) string
 31.                 gen onefund = _n
 32.                 gen onetrans = _n 
 33.                 gen zerofund = onefund-1
 34.                 gen zerotrans = onetrans-1
 35.                 // inst labels
.                 cap replace inst = "Caltech" if inst == "California Institute
>  of Technology"
 36.                 cap replace inst = "CDC" if inst == "Centers for Disease C
> ontrol and Prevention"
 37.                 cap replace inst = "Columbia" if inst == "Columbia Univers
> ity"
 38.                 cap replace inst = "Cornell" if inst == "Cornell Universit
> y"
 39.                 cap replace inst = "Duke" if inst == "Duke University"
 40.                 cap replace inst = "Harvard" if inst == "Harvard Universit
> y"
 41.                 cap replace inst = "JHU" if inst == "Johns Hopkins Univers
> ity"
 42.                 cap replace inst = "Rockefeller Univ." if inst == "The Roc
> kefeller University"
 43.                 cap replace inst = "MIT" if inst == "Massachusetts Institu
> te of Technology"
 44.                 cap replace inst = "Memorial Sloan" if inst == "Memorial S
> loan-Kettering Cancer Center"
 45.                 cap replace inst = "NYU" if inst == "New York University"
 46.                 cap replace inst = "Stanford" if inst == "Stanford Univers
> ity"
 47.                 cap replace inst = "UCL" if inst == "University College Lo
> ndon"
 48.                 cap replace inst = "UC Berkeley" if inst == "University of
>  California, Berkeley"
 49.                 cap replace inst = "UCLA" if inst == "University of Califo
> rnia, Los Angeles"
 50.                 cap replace inst = "UCSD" if inst == "University of Califo
> rnia, San Diego"
 51.                 cap replace inst = "UCSF" if inst == "University of Califo
> rnia, San Francisco"
 52.                 cap replace inst = "UChicago" if inst == "University of Ch
> icago"
 53.                 cap replace inst = "UMich" if inst == "University of Michi
> gan"
 54.                 cap replace inst = "UPenn" if inst == "University of Penns
> ylvania"
 55.                 cap replace inst = "Yale" if inst == "Yale University"
 56.                 cap replace inst = "Wash U" if inst == "Washington Univers
> ity in St. Louis"
 57.                 cap replace inst = "CAS" if inst == "Chinese Academy of Sc
> iences"
 58.                 cap replace inst = "Oxford" if inst == "University of Oxfo
> rd"
 59.                 cap replace inst = "Cambridge" if inst == "University of C
> ambridge"
 60.                 cap replace inst = "UT Dallas" if inst == "University of T
> exas, Dallas"
 61.                 cap replace inst = "UMich" if inst == "University of Michi
> gan, Ann Arbor"
 62.                 cap replace inst = "Dana Farber" if inst == "Dana Farber C
> ancer Institute"
 63.                 cap replace city_full = subinstr(city_full, "United States
> ", "US", .)
 64.                 cap replace city_full = subinstr(city_full, "United Kingdo
> m", "UK", .)
 65. 
.                 // cities
.                 cap replace city_full = subinstr(city_country, "United States
> ", "US",.)
 66.                 cap replace city_full = subinstr(city_country, "United Kin
> gdom", "UK",.)
 67.                 local lmt = 20
 68.                 gen lab = `type' if rankfund <= `lmt' | ranktrans<= `lmt'
 69.                 gen lab_share = `type' 
 70.                 cap replace lab_share = "" if inlist(inst, "UT Dallas", "U
> niversity of Washington", "Peking University", "Memorial Sloan", "UPenn", "UC
> L", "Medical Research Council")
 71.                 cap replace lab_share = "" if inlist(inst,  "UCLA", "UChic
> ago", "Oxford", "UMich", "Columbia", "Rockefeller Univ.")
 72.                 cap replace lab_share = "" if inlist(city_full, "Princeton
> , US", "Shanghai, China", "Saint Louis, US", "Research Triangle, US" , "Dalla
> s, US")
 73.                 cap replace lab_share = "" if inlist(city_full, "Seattle, 
> US", "Los Angeles, US",  "Houston, US", "Heidelberg, Germany", "Toronto, Cana
> da", "Chicago, US")
 74.                 cap replace lab_share = "" if inlist(city_full, "Baltimore
> , US", "Oxford, UK", "Paris, France", "Pasadena, US", "Philadelphia, US")
 75.                 cap replace lab_share = "" if !(inlist(rankfund, 1, 2, 3, 
> 5, 10, 12) | inlist(ranktrans, 1, 2, 3, 5, 10, 15))
 76.                 egen clock = mlabvpos(rankfund ranktrans)
 77. /*                cap replace clock = 4 if city_full == "Los Angeles, US"
>                 cap replace clock = 6 if city_full == "New York, US"
>                 cap replace clock = 3 if city_full == "Atlanta, US"
>                 cap replace clock = 3 if city_full == "Bethesda-DC, US"
>                 cap replace clock = 6 if city_full == "Boston-Cambridge, US"
>                 cap replace clock = 7 if city_full == "Cambridge, UK"
>                 cap replace clock = 9 if city_full == "Bay Area, US"
>                 cap replace clock = 3 if city_full == "New York, US"
>                 cap replace clock = 3 if city_full == "London, UL"
>                 cap replace clock = 3 if city_full == "New Haven, US"
>                 cap replace clock = 6 if city_full == "Ann Arbor, US"
>                 cap replace clock = 3 if city_full == "Beijing, China"
>                 cap replace clock = 3 if city_full == "San Diego-La Jolla, US
> "
>                 cap replace clock = 9 if city_full == "Cambridge, UK"
>                 cap replace clock = 11 if inst == "University of Cambridge"
>                 cap replace clock = 3 if inst == "Brigham and Women's Hospita
> l"
>                 cap replace clock = 12 if inst == "UC Berkeley"
>                 cap replace clock = 5 if inst == "Wash U"
>                 cap replace clock = 3 if inst == "MIT"
>                 cap replace clock = 12 if inst == "Caltech"
>                 cap replace clock = 9 if inst == "Stanford"
>                 cap replace clock = 9 if inst == "UCSD"
>                 cap replace clock = 9 if inst == "UCSF"
>                 cap replace clock = 9 if inst == "Yale"
>                 cap replace clock = 9 if inst == "NIH"
>                 cap replace clock = 4 if inst == "Cambridge"
>                 cap replace clock = 3 if inst == "CNRS"
>                 cap replace clock = 12 if inst == "Harvard"
>                 cap replace inst = "CAS" if inst == "Chinese Academy of Scien
> ces"
>                 cap replace clock = 9 if inst == "CAS"
>                 cap replace clock = 3 if inst == "CDC"
>                 cap replace clock = 3 if inst == "JHU"
>                 cap replace clock = 6 if inst == "Wash U"*/
.                 local rank_lmt = 20
 78.                 tw scatter rankfund ranktrans if inrange(rankfund , 1,`ran
> k_lmt') & inrange(ranktrans ,1,`rank_lmt'), ///
>                   mlabel(lab) mlabsize(vsmall) mlabcolor(black) mlabvp(clock)
>  || ///
>                   (line onefund onetrans if onefund <= `rank_lmt', lpattern(d
> ash) lcolor(lavender)), ///
>                   xtitle("``trans'_name' Research Output Rank", size(small)) 
> ytitle("`fund_name' Science Research Output Rank", size(small)) ///
>                   xlabel(1(1)`rank_lmt', labsize(vsmall)) ylabel(1(1)`rank_lm
> t', labsize(vsmall)) xsc(reverse) ysc(reverse) legend(off)
 79.                 *graph export ../output/figures/bt_`type'_`trans'_`samp'`s
> uf'_scatter.pdf, replace
.                 local skip = 0.5 
 80.                 if "`type'" == "inst" local lim = 5
 81.                 if "`type'" == "inst" local skip = 0.5 
 82.                 qui sum sharefund
 83.                 local max = r(max)
 84.                 qui sum sharetrans
 85.                 local max = max(r(max), `max')
 86.                 local max = floor(`max') +1 
 87.                 tw scatter sharefund sharetrans, ///
>                   mlabel(lab_share) mlabsize(vsmall) mlabcolor(black) mlabvp(
> clock) || ///
>                   (line zerofund zerotrans if zerofund <= `max', lpattern(das
> h) lcolor(lavender)), ///
>                   xtitle("Share of Worldwide ``trans'_name' Research Output (
> %)", size(small)) ytitle("Share of Worldwide `fund_name' Science Research Out
> put (%)", size(small)) ///
>                   xlabel(0(`skip')`max', labsize(vsmall)) ylabel(0(`skip')`ma
> x', labsize(vsmall)) legend(off)
 88.                 graph export ../output/figures/bt_`type'_`trans'_`samp'`su
> f'_share_scatter.pdf, replace
 89.             }
 90.             corr sharefund sharetrans
 91.         }
 92.     }
 93. end

.     
. program top_mesh_terms
  1.     syntax, data(str) samp(str) samp_type(str)
  2.     use ../external/`samp_type'_split/mesh_`data'_`samp'.dta, clear
  3.     qui merge m:1  pmid using ../external/`samp_type'_filtered/all_jrnl_ar
> ticles_`samp', assert(1 2 3) keep(3) nogen
  4.     qui merge m:1 pmid using ../external/wos/`samp'_appended, assert(1 2 3
> )  // restrict to those that were found in wos 
  5.     qui drop if _merge == 2
  6.     tab _merge
  7.     qui keep if strpos(doc_type, "Article")>0
  8.     qui drop if strpos(doc_type, "Retracted")>0
  9.     qui keep if _merge == 3 
 10.     drop _merge
 11. *    qui merge m:1 pmid using ../external/cleaned_samps/list_of_pmids_last
> 5yrs_`data'_`samp', keep(3) nogen
.     qui gunique pmid
 12.     local total_articles = r(unique)
 13.     qui replace mesh = subinstr(mesh, "=Y>","",.)
 14.     qui replace mesh = subinstr(mesh, "=N>","",.)
 15.     qui gen gen_mesh = mesh if strpos(mesh, ",") == 0 & strpos(mesh, ";") 
> == 0
 16.     qui replace gen_mesh = mesh if strpos(mesh, "Models") > 0
 17.     qui replace gen_mesh = subinstr(gen_mesh, "&; ", "&",.)
 18.     qui gen rev_mesh = reverse(mesh)
 19.     qui replace rev_mesh = substr(rev_mesh, strpos(rev_mesh, ",")+1, strle
> n(rev_mesh)-strpos(rev_mesh, ","))
 20.     qui replace rev_mesh = reverse(rev_mesh)
 21.     qui replace gen_mesh = rev_mesh if mi(gen_mesh) 
 22.     qui drop rev_mesh
 23.     preserve
 24.     qui gcontract pmid mesh, nomiss
 25.     qui save ../temp/contracted_mesh_`data'_`samp', replace
 26.     restore
 27.     gcontract pmid gen_mesh, nomiss
 28.     qui save ../temp/contracted_gen_mesh_`data'_`samp', replace
 29. 
.     foreach mesh in mesh gen_mesh {
 30.         use ../temp/contracted_`mesh'_`data'_`samp', clear
 31.         qui bys pmid: gen wt = 1/_N
 32.         qui bys pmid: gen num_`mesh' = _N
 33.         sum num_`mesh'
 34.         cap drop _freq
 35.         gcollapse (sum) article_wt = wt , by(`mesh')
 36.         qui hashsort -article_wt
 37.         qui gen perc = article_wt/`total_articles'*100
 38.         qui gen cum_perc = sum(perc) 
 39.         qui sum article_wt
 40.         local total = round(r(sum))
 41.         qui count
 42.         local rank_end = min(20,r(N))
 43.         li in 1/`rank_end'
 44.         mkmat article_wt perc cum_perc in 1/`rank_end', mat(top_`mesh'_`sa
> mp')
 45.         mat top_`mesh'_`data'_`samp' = top_`mesh'_`samp' \ (.,`total', .)
 46.         qui levelsof `mesh' in 1/3, local(`mesh'_terms_`data')
 47.         qui gen rank = _n
 48.         qui replace rank = 4 if rank > 3
 49.         qui replace `mesh' = "other" if rank == 4
 50.         qui gen inst = "total"
 51.         gcollapse (sum) article_wt perc cum_perc, by(inst `mesh' rank)
 52.         drop rank
 53.         qui save ../temp/`mesh'_`data'_`samp', replace
 54.        /* 
>         use ../temp/cleaned_last5yrs_`data'_`samp', clear
>         gcollapse (sum) affl_wt , by(pmid inst)
>         qui joinby pmid using ../temp/contracted_`mesh'_`data'_`samp'
>         qui bys pmid inst : gen num_`mesh' = _N
>         qui gen article_wt = affl_wt * 1/num_`mesh'
>         qui keep if inlist(inst, "Harvard University", "Stanford University",
>  "University of California, San Francisco", "NIH")
>         gen keep_`mesh' = 0
>         foreach m in ``mesh'_terms_`data'' {
>             qui replace keep_`mesh' = 1 if `mesh' == "`m'"
>         }
>         qui replace `mesh' = "other" if keep_`mesh' == 0
>         gcollapse (sum) article_wt , by(inst `mesh')
>         qui bys inst : egen tot = total(article_wt)
>         qui hashsort inst -article_wt
>         gen perc = article_wt/tot
>         gen cum_perc = sum(perc)
>         drop tot
>         append using ../temp/`mesh'_`data'_`samp'
>         qui save ../temp/`mesh'_`data'_`samp', replace*/
.     }
 55. end

. 
. program output_tables
  1.     syntax, data(str) samp(str)
  2.     foreach file in top_country top_city_full top_inst top_mesh top_gen_me
> sh {
  3.         qui matrix_to_txt, saving("../output/tables/`file'_`data'_`samp'.t
> xt") matrix(`file'_`data'_`samp') ///
>            title(<tab:`file'_`data'_`samp'>) format(%20.4f) replace
  4.          }
  5.  end

. ** 
. main
OUTPUT START

     +-------------------------------+
     | country   cite_a~t       perc |
     |-------------------------------|
 25. |           10.72199   .1524742 |
     +-------------------------------+

     +---------------------------+
     |        country       perc |
     |---------------------------|
  1. |  United States   53.21902 |
  2. | United Kingdom   9.210701 |
  3. |          China   7.161477 |
  4. |        Germany    7.05681 |
  5. |    Switzerland    2.60135 |
     |---------------------------|
  6. |         France   2.229374 |
  7. |         Canada   2.039727 |
  8. |          Japan   1.997191 |
  9. |      Australia   1.917995 |
 10. |         Sweden   1.759858 |
     |---------------------------|
 11. |    Netherlands   1.620287 |
 12. |         Israel   1.278869 |
 13. |        Austria   .8612521 |
 14. |        Belgium   .7939941 |
 15. |    South Korea   .7713806 |
     |---------------------------|
 16. |          Spain   .7573396 |
 17. |          Italy   .5583606 |
 18. |        Denmark   .5037805 |
 19. |      Singapore   .3709109 |
 20. |   South Africa   .3118772 |
     +---------------------------+
Total articles: 7032

      +--------------------------------+
      | city_f~l   cite_a~t       perc |
      |--------------------------------|
  99. |            10.72199   .1524742 |
      +--------------------------------+

     +----------------------------------------------+
     |                         city_full       perc |
     |----------------------------------------------|
  1. |   Boston-Cambridge, United States   11.19029 |
  2. |           Bay Area, United States   8.838695 |
  3. |           New York, United States   4.673433 |
  4. |            London, United Kingdom    3.48354 |
  5. |                    Beijing, China   3.403952 |
     |----------------------------------------------|
  6. | San Diego-La Jolla, United States   2.438442 |
  7. |            Seattle, United States   2.366712 |
  8. |         Cambridge, United Kingdom   2.031096 |
  9. |                   Shanghai, China   1.461873 |
 10. |            Oxford, United Kingdom   1.317098 |
     |----------------------------------------------|
 11. |        Bethesda-DC, United States   1.182193 |
 12. |             Dallas, United States   1.158765 |
 13. |                 Stockholm, Sweden   1.088246 |
 14. |           Pasadena, United States    1.08188 |
 15. |          Princeton, United States   1.077354 |
     |----------------------------------------------|
 16. |          New Haven, United States   1.016232 |
 17. |  Research Triangle, United States   .9987984 |
 18. |       Philadelphia, United States   .9331155 |
 19. |                   Rehovot, Israel   .8893663 |
 20. |        Los Angeles, United States   .8810939 |
     +----------------------------------------------+
Total articles: 7032

      +----------------------------+
      | inst   cite_a~t       perc |
      |----------------------------|
   3. |        197.7186   2.811698 |
      +----------------------------+

     +----------------------------------------------------+
     |                                    inst       perc |
     |----------------------------------------------------|
  1. |                      Harvard University   4.786355 |
  2. |                     Stanford University   3.791439 |
  3. |                              Max Planck   2.202622 |
  4. | University of California, San Francisco   2.129182 |
  5. |                University of Washington   1.993269 |
     |----------------------------------------------------|
  6. |   Massachusetts Institute of Technology   1.987049 |
  7. |             Chinese Academy of Sciences   1.974986 |
  8. |      University of California, Berkeley   1.653126 |
  9. |                                DeepMind   1.623228 |
 10. |                    University of Oxford   1.234136 |
     |----------------------------------------------------|
 11. |                                   Broad   1.228679 |
 12. |                                    CNRS   1.166113 |
 13. |              The Rockefeller University   1.160433 |
 14. |                                     NIH    1.12322 |
 15. |             University of Texas, Dallas   1.066125 |
     |----------------------------------------------------|
 16. |      California Institute of Technology   1.023999 |
 17. |                         Yale University   1.008502 |
 18. |                     Columbia University   .9971432 |
 19. |     University of California, San Diego   .8892629 |
 20. |           Weizmann Institute of Science   .8885254 |
     +----------------------------------------------------+
Total articles: 7032
1063 authors of 87372 are broad affiliated or 1.2166369 percent
1049 US authors of 44152 are broad affiliated or 2.3758833 percent
(55,499 observations deleted)
3 stanford authors of 1049 are broad affiliated or .28598665 percent
510 harvard authors of 1049 are broad affiliated or 48.617731 percent
(98,147 observations deleted)
510 harvard authors of 984 are broad affiliated or 51.829268 percent
323 mit authors of 984 are broad affiliated or 32.825203 percent
3516 authors of 87372 are hhmi affiliated or 4.0241725 percent
3510 US authors of 44152 are hhmi affiliated or 7.9498097 percent
(55,499 observations deleted)
442 stanford authors of 3510 are hhmi affiliated or 12.592593 percent
553 harvard authors of 3510 are hhmi affiliated or 15.754986 percent

   Matching result from |
                  merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        Master only (1) |      3,301        1.74        1.74
            Matched (3) |    186,288       98.26      100.00
------------------------+-----------------------------------
                  Total |    189,589      100.00

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    num_mesh |    172,505    5.177908    1.850469          1         14

     +-----------------------------------------------------------------------+
     |                                 mesh   articl~t       perc   cum_perc |
     |-----------------------------------------------------------------------|
  1. |                 Biological Evolution   241.1107   .6212273   .6212273 |
  2. |                  Signal Transduction   232.6898   .5995306   1.220758 |
  3. |                            Ecosystem   198.4623   .5113426     1.7321 |
  4. |                  Neurons, physiology    180.252   .4644233   2.196524 |
  5. |    Transcription Factors, metabolism   178.1282   .4589513   2.655475 |
     |-----------------------------------------------------------------------|
  6. |     DNA-Binding Proteins, metabolism   168.4785   .4340886   3.089564 |
  7. |               Transcription, Genetic   162.7373   .4192964    3.50886 |
  8. |                              Fossils   151.0944   .3892983   3.898159 |
  9. |           Gene Expression Regulation   142.6297   .3674888   4.265647 |
 10. |   Saccharomyces cerevisiae, genetics   136.0214   .3504622   4.616109 |
     |-----------------------------------------------------------------------|
 11. |        Membrane Proteins, metabolism   118.4534   .3051978   4.921307 |
 12. |                  Drosophila Proteins   114.6952   .2955148   5.216822 |
 13. |    Saccharomyces cerevisiae Proteins   109.2205   .2814092   5.498231 |
 14. |                 Evolution, Molecular   104.7218   .2698182   5.768049 |
 15. |                 Proteins, metabolism   95.48611   .2460221   6.014071 |
     |-----------------------------------------------------------------------|
 16. | Saccharomyces cerevisiae, metabolism   95.46236    .245961   6.260032 |
 17. |                  Calcium, metabolism   90.79448    .233934   6.493967 |
 18. |         Carrier Proteins, metabolism   87.47616   .2253843   6.719351 |
 19. |         Nuclear Proteins, metabolism   86.46253   .2227727   6.942123 |
 20. |            T-Lymphocytes, immunology   86.15754   .2219869    7.16411 |
     +-----------------------------------------------------------------------+

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
num_gen_mesh |    161,013    4.824486     1.73228          1         14

     +--------------------------------------------------------------------+
     |                          gen_mesh   articl~t       perc   cum_perc |
     |--------------------------------------------------------------------|
  1. |             Transcription Factors   392.6385   1.011642   1.011642 |
  2. |              DNA-Binding Proteins   352.8333   .9090831   1.920725 |
  3. |          Saccharomyces cerevisiae   339.4227   .8745302   2.795255 |
  4. |                           Neurons    335.315   .8639468   3.659202 |
  5. |        Gene Expression Regulation   313.9168   .8088136   4.468016 |
     |--------------------------------------------------------------------|
  6. |                             Genes   301.5781   .7770229   5.245039 |
  7. |               Signal Transduction   299.0691   .7705583   6.015597 |
  8. |                               DNA   257.6111   .6637409   6.679338 |
  9. |              Biological Evolution   254.4341   .6555553   7.334893 |
 10. |                 Membrane Proteins   249.7811   .6435666    7.97846 |
     |--------------------------------------------------------------------|
 11. | Saccharomyces cerevisiae Proteins   232.3271   .5985961   8.577056 |
 12. |                          Proteins   230.6805   .5943536    9.17141 |
 13. |           Drosophila melanogaster   225.8279   .5818508   9.753261 |
 14. |                Bacterial Proteins   212.1381   .5465786   10.29984 |
 15. |               Drosophila Proteins   209.8873   .5407794   10.84062 |
     |--------------------------------------------------------------------|
 16. |                         Ecosystem   203.1131   .5233255   11.36394 |
 17. |                  Escherichia coli   200.0833   .5155192   11.87946 |
 18. |                            Genome   183.4905   .4727675   12.35223 |
 19. |                       Arabidopsis   182.2025   .4694489   12.82168 |
 20. |                  Nuclear Proteins   178.0567   .4587671   13.28045 |
     +--------------------------------------------------------------------+

   Matching result from |
                  merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        Master only (1) |        989        2.66        2.66
            Matched (3) |     36,221       97.34      100.00
------------------------+-----------------------------------
                  Total |     37,210      100.00

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    num_mesh |     31,961    5.669441     1.67736          1         13

     +-------------------------------------------------------------------+
  1. |                                        mesh | articl~t |     perc |
     |                                    Mutation | 50.23294 | .8000149 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             .8000149                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  2. |                                        mesh | articl~t |     perc |
     |                         Neoplasms, genetics | 36.54246 |  .581979 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             1.381994                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  3. |                                        mesh | articl~t |     perc |
     |                         Signal Transduction | 27.82103 | .4430806 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             1.825075                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  4. |                                        mesh | articl~t |     perc |
     |             Cell Transformation, Neoplastic | 26.87818 | .4280646 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             2.253139                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  5. |                                        mesh | articl~t |     perc |
     |                          Mutation, genetics | 23.34091 | .3717297 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             2.624869                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  6. |                                        mesh | articl~t |     perc |
     |                        Neoplasms, pathology | 22.19564 |   .35349 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             2.978359                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  7. |                                        mesh | articl~t |     perc |
     |                                    COVID-19 | 18.22976 | .2903291 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             3.268688                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  8. |                                        mesh | articl~t |     perc |
     |                       Neoplasms, metabolism | 17.98373 | .2864107 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             3.555099                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
  9. |                                        mesh | articl~t |     perc |
     |                  Breast Neoplasms, genetics | 16.37302 | .2607583 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             3.815857                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 10. |                                        mesh | articl~t |     perc |
     |      Gene Expression Regulation, Neoplastic | 15.13254 | .2410024 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             4.056859                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 11. |                                        mesh | articl~t |     perc |
     |           Genetic Predisposition to Disease | 14.15476 | .2254302 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                              4.28229                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 12. |                                        mesh | articl~t |     perc |
     |           Transcription Factors, metabolism | 14.13492 | .2251142 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             4.507404                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 13. |                                        mesh | articl~t |     perc |
     |                       Neoplasms, immunology | 14.13135 | .2250573 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             4.732461                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 14. |                                        mesh | articl~t |     perc |
     |                   T-Lymphocytes, immunology | 13.92662 | .2217968 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             4.954258                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 15. |                                        mesh | articl~t |     perc |
     |              DNA-Binding Proteins, genetics | 13.83258 |  .220299 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             5.174557                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 16. |                                        mesh | articl~t |     perc |
     |                     Genome, Human, genetics | 13.28929 | .2116465 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             5.386203                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 17. |                                        mesh | articl~t |     perc |
     |            DNA-Binding Proteins, metabolism | 13.06151 | .2080189 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             5.594223                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 18. |                                        mesh | articl~t |     perc |
     |                          Proteins, genetics |  12.9044 | .2055168 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             5.799739                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 19. |                                        mesh | articl~t |     perc |
     |                 Breast Neoplasms, pathology | 12.81627 | .2041132 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             6.003852                              |
     +-------------------------------------------------------------------+

     +-------------------------------------------------------------------+
 20. |                                        mesh | articl~t |     perc |
     | Genetic Predisposition to Disease, genetics | 12.50238 | .1991142 |
     |-------------------------------------------------------------------|
     |                             cum_perc                              |
     |                             6.202967                              |
     +-------------------------------------------------------------------+

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
num_gen_mesh |     29,036    5.152845    1.573104          1         11

     +--------------------------------------------------------------------+
     |                          gen_mesh   articl~t       perc   cum_perc |
     |--------------------------------------------------------------------|
  1. |                         Neoplasms   110.5123    1.76003    1.76003 |
  2. |                          Mutation      85.95   1.368849   3.128879 |
  3. |                          COVID-19   47.19087   .7515667   3.880445 |
  4. |                             Genes   46.79048     .74519   4.625636 |
  5. |                  Breast Neoplasms    42.9123   .6834257   5.309061 |
     |--------------------------------------------------------------------|
  6. |              DNA-Binding Proteins   40.82269   .6501464   5.959208 |
  7. |             Transcription Factors   37.96476   .6046306   6.563838 |
  8. |                      Inflammation   36.43929   .5803358   7.144174 |
  9. |                 Alzheimer Disease   36.00397   .5734029   7.717577 |
 10. |        Gene Expression Regulation   35.75873   .5694972   8.287074 |
     |--------------------------------------------------------------------|
 11. |               Signal Transduction   35.24802   .5613635   8.848437 |
 12. |                        SARS-CoV-2   32.72738   .5212197   9.369658 |
 13. |               Cell Transformation   32.42183   .5163533    9.88601 |
 14. |                 Membrane Proteins   32.35357   .5152663   10.40128 |
 15. |                    HIV Infections   32.33968   .5150451   10.91632 |
     |--------------------------------------------------------------------|
 16. |                          Proteins   29.18214   .4647578   11.38108 |
 17. |                          Melanoma   28.58968   .4553222    11.8364 |
 18. | Genetic Predisposition to Disease   27.85238   .4435799   12.27998 |
 19. |                             HIV-1   27.84087   .4433966   12.72338 |
 20. |             Nerve Tissue Proteins   25.80325   .4109452   13.13432 |
     +--------------------------------------------------------------------+

. 
end of do-file

--------------------------------------------------------------------------------
Makelog ended: 2023-01-28 09:24:55
Working directory: /export/home/dor/cxu/innovation_projs/analysis/science_geo/cns_descriptives/code
--------------------------------------------------------------------------------
